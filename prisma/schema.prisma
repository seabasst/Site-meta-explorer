// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  name               String?
  image              String?
  stripeCustomerId   String?  @unique
  subscriptionStatus String   @default("free") // free, pro, past_due, cancelled
  subscriptionId     String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  ownBrand    TrackedBrand?  @relation("OwnBrand")
  competitors TrackedBrand[] @relation("Competitors")
  snapshots   BrandSnapshot[]
}

model TrackedBrand {
  id             String   @id @default(cuid())
  facebookPageId String
  pageName       String
  adLibraryUrl   String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Owner relation (1:1) — this is the user's own brand
  ownerId String? @unique
  owner   User?   @relation("OwnBrand", fields: [ownerId], references: [id], onDelete: Cascade)

  // Tracker relation (1:many) — this is a competitor being tracked
  trackerId String?
  tracker   User?   @relation("Competitors", fields: [trackerId], references: [id], onDelete: Cascade)

  snapshots BrandSnapshot[]

  @@unique([trackerId, facebookPageId])
}

model BrandSnapshot {
  id             String   @id @default(cuid())
  snapshotDate   DateTime @default(now())
  createdAt      DateTime @default(now())

  // Scalar metrics
  totalAdsFound    Int
  activeAdsCount   Int
  totalReach       BigInt
  avgReachPerAd    Float
  estimatedSpendUsd Float
  videoCount       Int
  imageCount       Int
  videoPercentage  Float
  imagePercentage  Float
  avgAdAgeDays     Float
  dominantGender   String?
  dominantGenderPct Float?
  dominantAgeRange String?
  dominantAgePct   Float?

  // Top 3 countries
  topCountry1Code String?
  topCountry1Pct  Float?
  topCountry2Code String?
  topCountry2Pct  Float?
  topCountry3Code String?
  topCountry3Pct  Float?

  // JSON fields for full breakdowns
  demographicsJson   Json?
  spendByCountryJson Json?

  // Relations
  trackedBrandId String
  trackedBrand   TrackedBrand @relation(fields: [trackedBrandId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  hookGroups HookGroup[]

  @@index([trackedBrandId, snapshotDate])
}

model HookGroup {
  id             String   @id @default(cuid())
  hookText       String   // Original text of the hook (first occurrence)
  normalizedText String   // Normalized version used for grouping
  frequency      Int      // Number of ads with this hook
  totalReach     BigInt   // Sum of euTotalReach across all ads
  avgReachPerAd  Float    // totalReach / frequency
  adIds          Json     // Array of ad IDs in this group (string[])
  createdAt      DateTime @default(now())

  // Relations
  snapshotId     String
  snapshot       BrandSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
  @@index([snapshotId, totalReach])
}
