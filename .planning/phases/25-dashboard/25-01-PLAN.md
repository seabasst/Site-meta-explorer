---
phase: 25-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/dashboard/competitor-card.tsx
  - src/app/dashboard/[brandId]/page.tsx
  - src/app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Each brand card shows top country and last analyzed date alongside existing metrics"
    - "User can click a brand card to navigate to a detail page with full demographics"
    - "User can sort competitors by name or date"
    - "User can search competitors by name"
  artifacts:
    - path: "src/components/dashboard/competitor-card.tsx"
      provides: "Enhanced card with top country, last analyzed date, clickable wrapper"
      contains: "topCountry1Code"
    - path: "src/app/dashboard/[brandId]/page.tsx"
      provides: "Brand detail page with full demographics breakdown"
      contains: "demographicsJson"
    - path: "src/app/dashboard/page.tsx"
      provides: "Search input and sort controls above competitors grid"
      contains: "sortBy"
  key_links:
    - from: "src/components/dashboard/competitor-card.tsx"
      to: "/dashboard/[brandId]"
      via: "Next.js Link wrapping the card"
      pattern: "href.*dashboard.*brandId"
    - from: "src/app/dashboard/[brandId]/page.tsx"
      to: "/api/dashboard/overview"
      via: "Fetches brand data including demographicsJson"
      pattern: "demographicsJson"
    - from: "src/app/dashboard/page.tsx"
      to: "competitors.filter"
      via: "Search and sort state filtering the grid"
      pattern: "filter.*search|sort"
---

<objective>
Enhance the existing dashboard with card-level metrics (top country, last analyzed date), clickable cards leading to a brand detail page with full demographics, and search/sort controls for the competitors grid.

Purpose: Complete the DASH-01 through DASH-04 requirements by incrementally enhancing existing dashboard components.
Output: Enhanced competitor cards, a new brand detail page, and search/sort UI controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/dashboard/competitor-card.tsx
@src/app/dashboard/page.tsx
@src/hooks/use-tracked-brands.ts
@src/app/api/dashboard/overview/route.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance CompetitorCard with top country, last analyzed date, and clickable link</name>
  <files>src/components/dashboard/competitor-card.tsx</files>
  <action>
Modify the existing CompetitorCard component to add three things:

1. **Top country display**: Below the existing MetricRow items, add a row showing the top country. Use `snapshot.topCountry1Code` and `snapshot.topCountry1Pct`. Display as e.g. "Top Country: US (42%)". Use the same MetricRow pattern but with a custom format, or a simple inline display. If topCountry1Code is null, skip this row.

2. **Last analyzed date**: Add a small text line below the metrics showing when the snapshot was taken. Use `snapshot.snapshotDate` formatted as a relative date (e.g. "2 days ago") or short date (e.g. "Jan 28"). Place it at the bottom of the card in text-[var(--text-muted)] text-[10px]. Use `new Date(snapshot.snapshotDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })` for simplicity.

3. **Make the card clickable**: Wrap the entire card in a Next.js `Link` component pointing to `/dashboard/${competitor.id}`. Add `href` prop to the CompetitorCard props interface so the parent can pass it, OR just construct the URL inside the component using `competitor.id`. Use `next/link`. Add hover state: `hover:border-[var(--border-medium)] transition-colors cursor-pointer` to the outer div. Keep the Remove and Refresh buttons functional by adding `e.stopPropagation()` on their click handlers (or use `e.preventDefault()` on the Link wrapper for those button areas).

Important: Use Link from next/link wrapping the card. The Remove and Refresh buttons need `onClick` with `e.preventDefault(); e.stopPropagation();` to prevent navigation when clicked. Structure: wrap the card content in Link, but keep buttons outside the Link or use event stopping.

Preferred approach: Make the outer div a Link, and wrap the buttons in a div with `onClick={(e) => e.preventDefault()}` to prevent Link navigation when clicking buttons.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Visually inspect that the card still renders correctly with the new fields.
  </verify>
  <done>
CompetitorCard shows top country code + percentage, last analyzed date, and is wrapped in a Link to /dashboard/[brandId]. Buttons still work without triggering navigation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create brand detail page with full demographics</name>
  <files>src/app/dashboard/[brandId]/page.tsx</files>
  <action>
Create a new Next.js page at `src/app/dashboard/[brandId]/page.tsx` that displays full demographic details for a single brand.

**Data fetching**: This is a client component ('use client'). Fetch brand data from `/api/dashboard/overview` (reuse the existing endpoint) and find the brand by ID from either ownBrand or competitors array. Use the `useTrackedBrands` hook. Extract the brand matching `params.brandId`.

**Page layout**:
1. **Back navigation**: A link back to `/dashboard` at the top. Use `<- Back to Dashboard` text with Link from next/link. Style: `text-sm text-[var(--text-muted)] hover:text-[var(--text-primary)]`.

2. **Brand header**: Show `brand.pageName` as h1 (font-serif text-3xl text-[var(--text-primary)]). Below it, show the Ad Library URL as a small external link.

3. **Key metrics summary**: A row of metric boxes (using `bg-[var(--bg-tertiary)] rounded-lg p-4` pattern) showing: Active Ads, Total Reach, Est. Spend, Avg Ad Age, Top Country, Dominant Gender, Dominant Age Range. Pull all from `snapshot` (the first/latest snapshot). Use the same formatting helpers from competitor-card or inline them.

4. **Demographics breakdown** (the main new content):
   Parse `snapshot.demographicsJson` (it's stored as a JSON object). The structure contains age/gender breakdowns. Display:
   - **Gender distribution**: Simple bar or percentage display showing male/female/unknown split
   - **Age range distribution**: Horizontal bars showing each age range and its percentage
   - **Country distribution**: List the top 3 countries with percentages (from topCountry1Code/Pct, topCountry2Code/Pct, topCountry3Code/Pct), plus if spendByCountryJson has more detail, show that too

   Use the glass card pattern (`.glass rounded-2xl p-6`) for each section.

5. **Loading state**: Show skeleton while useTrackedBrands loads.
6. **Not found state**: If brandId doesn't match any brand, show "Brand not found" with a link back.

**Important**: The demographicsJson structure from Phase 24 stores the full breakdown. Check the shape by looking at what the save endpoint stores. It likely has `{ gender: {male: N, female: N}, age: {"18-24": N, "25-34": N, ...}, country: {"US": N, "GB": N, ...} }` or similar. Parse it defensively with fallbacks.

For the page params in Next.js 16 (App Router), use:
```tsx
export default function BrandDetailPage({ params }: { params: Promise<{ brandId: string }> }) {
```
Use `React.use(params)` to unwrap the promise (Next.js 15+ pattern).

Wrap the page content in the same layout structure as the dashboard: gradient-mesh, noise-overlay, DashboardNav. OR simpler: just use the existing dashboard layout.tsx which should already wrap this page since it's a child route of /dashboard.

Check if `src/app/dashboard/layout.tsx` exists and what it provides. If it already wraps children, just render the page content directly.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Navigate to `/dashboard/[someBrandId]` and verify the page loads with brand details. If no real data, at minimum verify the page renders without crashing (loading state, then not-found if no matching brand).
  </verify>
  <done>
Brand detail page at /dashboard/[brandId] renders full demographics including gender distribution, age range breakdown, and country breakdown from the stored snapshot data. Back link returns to dashboard. Loading and not-found states handled.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add search input and sort controls to competitors grid</name>
  <files>src/app/dashboard/page.tsx</files>
  <action>
Add search and sort functionality to the competitors section of the dashboard page.

1. **State**: Add two state variables at the top of DashboardPage:
   ```tsx
   const [searchQuery, setSearchQuery] = useState('');
   const [sortBy, setSortBy] = useState<'name' | 'date'>('date');
   ```

2. **Filter and sort the competitors array**: Before rendering, compute a filtered/sorted list:
   ```tsx
   const filteredCompetitors = competitors
     .filter(c => c.pageName.toLowerCase().includes(searchQuery.toLowerCase()))
     .sort((a, b) => {
       if (sortBy === 'name') return a.pageName.localeCompare(b.pageName);
       // Sort by latest snapshot date (newest first), fall back to createdAt
       const dateA = a.snapshots[0]?.snapshotDate || a.createdAt;
       const dateB = b.snapshots[0]?.snapshotDate || b.createdAt;
       return new Date(dateB).getTime() - new Date(dateA).getTime();
     });
   ```

3. **UI controls**: Add a controls bar between the "Competitors (N)" header and the grid. Place it inside the existing `.glass.rounded-2xl.p-6` container for the competitors section. Layout:
   ```
   [Search input........................] [Sort: Date v] [Sort: Name v]
   ```

   - **Search input**: An input with placeholder "Search brands..." styled as:
     `bg-[var(--bg-tertiary)] border border-[var(--border-subtle)] rounded-lg px-3 py-2 text-sm text-[var(--text-primary)] placeholder:text-[var(--text-muted)] focus:outline-none focus:border-[var(--accent-green)] w-full sm:w-64`
     Use a search icon (magnifying glass SVG or lucide-react Search icon) inside the input.

   - **Sort buttons**: Two small toggle buttons for "Date" and "Name". Active state: `bg-[var(--accent-green)] text-white`. Inactive: `bg-[var(--bg-tertiary)] text-[var(--text-muted)] border border-[var(--border-subtle)]`. Both: `px-3 py-2 text-xs rounded-lg transition-colors`.

   Put search on the left and sort buttons on the right using `flex items-center justify-between gap-3 mb-4`.

4. **Update the grid**: Replace `competitors.map(...)` with `filteredCompetitors.map(...)`. Show empty state when filteredCompetitors is empty but competitors has items: "No brands match your search."

5. **Update the count**: Change the competitors count display from `({competitors.length})` to `({filteredCompetitors.length}${searchQuery ? ` of ${competitors.length}` : ''})` so the user sees the filtered count.

Import Search icon from lucide-react (already in the project dependencies â€” it's used elsewhere).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify search filters brands by name and sort toggles between alphabetical and date order.
  </verify>
  <done>
Dashboard has a search input that filters competitors by name in real-time, and sort toggle buttons that switch between date (newest first) and name (alphabetical) ordering. Empty search state shows appropriate message. Count reflects filtered results.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully
3. CompetitorCard displays top country and last analyzed date
4. Clicking a competitor card navigates to /dashboard/[brandId]
5. Brand detail page shows full demographics breakdown (gender, age, country)
6. Search input filters competitors by name
7. Sort buttons toggle between date and name ordering
8. Remove and Refresh buttons on cards still work without triggering navigation
</verification>

<success_criteria>
- DASH-01: Cards show key metrics including top country and last analyzed date
- DASH-02: Cards link to /dashboard/[brandId] with full demographic breakdown
- DASH-03: Sort controls allow ordering by date or name
- DASH-04: Search input filters brands by name in real-time
</success_criteria>

<output>
After completion, create `.planning/phases/25-dashboard/25-01-SUMMARY.md`
</output>
