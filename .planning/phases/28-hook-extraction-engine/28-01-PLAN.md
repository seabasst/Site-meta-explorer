---
phase: 28-hook-extraction-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/hook-extractor.ts
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Hook extractor correctly extracts first sentence from ad creative text"
    - "Normalizer groups semantically identical hooks (case, emoji, punctuation differences)"
    - "Grouping function computes frequency, total reach, and average reach per ad"
    - "HookGroup model exists in database with proper indexes"
  artifacts:
    - path: "src/lib/hook-extractor.ts"
      provides: "Pure hook extraction, normalization, and grouping functions"
      exports: ["extractHook", "normalizeHook", "groupHooks", "HookGroupData", "RawAdHook"]
    - path: "prisma/schema.prisma"
      provides: "HookGroup model linked to BrandSnapshot"
      contains: "model HookGroup"
  key_links:
    - from: "prisma/schema.prisma HookGroup"
      to: "prisma/schema.prisma BrandSnapshot"
      via: "snapshotId foreign key with onDelete: Cascade"
      pattern: "snapshot.*BrandSnapshot.*onDelete.*Cascade"
---

<objective>
Create the hook extraction module and database model for persisting ad creative hooks.

Purpose: This is the data foundation for Phase 28 -- the pure extraction/normalization/grouping logic and the Prisma model that stores hook groups per brand snapshot. Plan 02 will wire these into the save and re-analysis flows.

Output: `src/lib/hook-extractor.ts` with tested pure functions, `HookGroup` Prisma model with migration applied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-hook-extraction-engine/28-RESEARCH.md

@prisma/schema.prisma
@src/lib/snapshot-builder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hook-extractor.ts module</name>
  <files>src/lib/hook-extractor.ts</files>
  <action>
Create `src/lib/hook-extractor.ts` with these exports:

1. **`extractHook(text: string): string`** - Extracts first sentence from ad creative text.
   - Trim input. Return '' if empty.
   - Try regex `^(.+?[.!?])(?:\s|$)` to find first sentence. Only accept if result >= 10 chars (avoids splitting on "3.5" or "U.S.").
   - Fallback: first line (split on `\n`), up to 150 chars.
   - Last resort: truncate to 100 chars.

2. **`normalizeHook(text: string): string`** - Normalizes hook for grouping.
   - Lowercase.
   - Strip emojis using Unicode regex range: `[\u{1F300}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE00}-\u{FE0F}\u{200D}\u{20E3}\u{E0020}-\u{E007F}\u{2700}-\u{27BF}\u{231A}-\u{231B}\u{23E9}-\u{23F3}\u{23F8}-\u{23FA}\u{25AA}-\u{25AB}\u{25B6}\u{25C0}\u{25FB}-\u{25FE}\u{2614}-\u{2615}\u{2648}-\u{2653}\u{267F}\u{2693}\u{26A1}\u{26AA}-\u{26AB}\u{26BD}-\u{26BE}\u{26C4}-\u{26C5}\u{26CE}\u{26D4}\u{26EA}\u{26F2}-\u{26F3}\u{26F5}\u{26FA}\u{26FD}\u{2702}\u{2705}\u{2708}-\u{270D}\u{270F}]/gu`
   - Strip punctuation but KEEP numbers and letters: `.replace(/[^\w\s]/g, '')`
   - Collapse whitespace, trim.

3. **`RawAdHook` interface** - `{ adId: string; hookText: string; euTotalReach: number; }`

4. **`HookGroupData` interface** - `{ hookText: string; normalizedText: string; frequency: number; totalReach: number; avgReachPerAd: number; adIds: string[]; }`

5. **`groupHooks(hooks: RawAdHook[]): HookGroupData[]`** - Groups hooks by normalized text.
   - Skip hooks where normalized length < 5 (filters garbage).
   - For each group: keep first hookText as display text, collect adIds, sum totalReach.
   - Compute avgReachPerAd = totalReach / frequency.
   - Sort result by totalReach descending.

6. **`extractHooksFromAds(ads: Array<{ id: string; ad_creative_bodies?: string[]; eu_total_reach?: number }>): HookGroupData[]`** - Convenience function that:
   - Iterates all ads, processes ALL elements in `ad_creative_bodies[]` (not just [0]).
   - Deduplicates hooks within a single ad (same normalized text from different creative body variants).
   - Returns grouped hooks.

Use the code patterns from 28-RESEARCH.md as reference but ensure the `extractHooksFromAds` convenience function is added. This function is what the API routes will call.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Manually verify the file exports the expected functions by checking its content.
  </verify>
  <done>
`src/lib/hook-extractor.ts` exists with all 5 exports. TypeScript compiles without errors. Functions handle edge cases (empty text, short hooks, emoji-heavy text, multi-body ads).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add HookGroup Prisma model and run migration</name>
  <files>prisma/schema.prisma</files>
  <action>
Add `HookGroup` model to `prisma/schema.prisma`:

```prisma
model HookGroup {
  id             String   @id @default(cuid())
  hookText       String   // Original text of the hook (first occurrence)
  normalizedText String   // Normalized version used for grouping
  frequency      Int      // Number of ads with this hook
  totalReach     BigInt   // Sum of euTotalReach across all ads
  avgReachPerAd  Float    // totalReach / frequency
  adIds          Json     // Array of ad IDs in this group (string[])
  createdAt      DateTime @default(now())

  // Relations
  snapshotId     String
  snapshot       BrandSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
  @@index([snapshotId, totalReach])
}
```

Also add `hookGroups HookGroup[]` to the `BrandSnapshot` model's relations.

Then run: `npx prisma migrate dev --name add-hook-groups`

IMPORTANT: Use `BigInt` for `totalReach` to match the `BrandSnapshot.totalReach` type. Use the existing `serializeSnapshot` pattern (BigInt -> Number) when returning hook data in API responses (this will be wired in Plan 02).
  </action>
  <verify>
Run `npx prisma migrate dev --name add-hook-groups` and confirm migration succeeds. Run `npx prisma generate` and confirm the Prisma client is updated. Check that `npx tsc --noEmit` still passes.
  </verify>
  <done>
HookGroup model exists in schema.prisma with snapshotId FK, cascade delete, and indexes. Migration applied successfully. BrandSnapshot has `hookGroups` relation.
  </done>
</task>

</tasks>

<verification>
1. `src/lib/hook-extractor.ts` exists and exports `extractHook`, `normalizeHook`, `groupHooks`, `extractHooksFromAds`, `HookGroupData`, `RawAdHook`
2. `prisma/schema.prisma` contains `model HookGroup` with `snapshotId` FK
3. `BrandSnapshot` model has `hookGroups HookGroup[]` relation
4. `npx tsc --noEmit` passes
5. Database migration applied successfully
</verification>

<success_criteria>
- Hook extraction functions exist and handle edge cases (empty, short, emoji, multiline text)
- HookGroup table exists in database with proper indexes
- Cascade delete ensures hooks are cleaned up when snapshots are deleted
- All existing code still compiles (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/28-hook-extraction-engine/28-01-SUMMARY.md`
</output>
