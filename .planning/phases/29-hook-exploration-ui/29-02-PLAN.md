---
phase: 29-hook-exploration-ui
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/components/dashboard/hook-explorer.tsx
  - src/components/dashboard/hook-card.tsx
  - src/app/dashboard/[brandId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees an Opening Hooks section on the brand detail page below country distribution"
    - "Hook cards are sorted by totalReach descending (highest reach first)"
    - "User can type in a search box and hook list filters by text content in real time"
    - "User can click a hook card to expand it and see a list of Facebook Ad Library links"
    - "Pre-Phase-28 snapshots show an empty state message guiding re-analysis"
  artifacts:
    - path: "src/components/dashboard/hook-explorer.tsx"
      provides: "Main hook section with search bar and hook card list"
      min_lines: 40
    - path: "src/components/dashboard/hook-card.tsx"
      provides: "Individual expandable hook card component"
      min_lines: 30
    - path: "src/app/dashboard/[brandId]/page.tsx"
      provides: "Brand detail page with HookExplorer integrated"
      contains: "HookExplorer"
  key_links:
    - from: "src/app/dashboard/[brandId]/page.tsx"
      to: "/api/dashboard/hooks"
      via: "fetch in useEffect/useCallback triggered by snapshot.id"
      pattern: "api/dashboard/hooks"
    - from: "src/components/dashboard/hook-explorer.tsx"
      to: "src/components/dashboard/hook-card.tsx"
      via: "import and render in map"
      pattern: "HookCard"
    - from: "src/components/dashboard/hook-card.tsx"
      to: "facebook.com/ads/library"
      via: "anchor href with ad ID"
      pattern: "facebook\\.com/ads/library"
---

<objective>
Build the HookExplorer and HookCard UI components, then wire them into the brand detail page. Users will see a searchable, expandable hook card list sorted by reach.

Purpose: This completes HOOK-04 (view hooks ranked by reach), HOOK-05 (search/filter by text), and HOOK-06 (expand to see ads).
Output: Two new component files and a modified brand detail page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-hook-exploration-ui/29-RESEARCH.md
@.planning/phases/29-hook-exploration-ui/29-01-SUMMARY.md

@src/app/dashboard/[brandId]/page.tsx (brand detail page -- integrate HookExplorer here)
@src/app/dashboard/page.tsx (search input pattern at lines 265-273)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HookCard and HookExplorer components</name>
  <files>src/components/dashboard/hook-card.tsx, src/components/dashboard/hook-explorer.tsx</files>
  <action>
**First, create `src/components/dashboard/hook-card.tsx`:**

A client component ('use client') that renders a single hook group as an expandable card.

Props interface:
```typescript
interface HookCardProps {
  id: string;
  hookText: string;
  frequency: number;
  totalReach: number;
  avgReachPerAd: number;
  adIds: string[];
  expanded: boolean;
  onToggle: () => void;
}
```

Structure:
- Outer div: `rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border-subtle)]`
- Clickable button (full width, flex, justify-between, p-4, text-left):
  - Left side: hookText as `text-sm text-[var(--text-primary)] font-medium` (use `line-clamp-2` not `truncate` -- hooks can be multi-line)
  - Below hookText: a flex row with `text-xs text-[var(--text-muted)]` showing "{frequency} ads" and "{formatReach(totalReach)} reach"
  - Right side: ChevronDown icon from lucide-react, `w-4 h-4 text-[var(--text-muted)]`, with `transition-transform` and `rotate-180` when expanded
- Expanded section (conditionally rendered):
  - `border-t border-[var(--border-subtle)] p-4`
  - Heading: `text-xs text-[var(--text-muted)] uppercase tracking-wider mb-2` saying "Ads using this hook"
  - List of ad links: each ad ID rendered as an anchor `<a>` pointing to `https://www.facebook.com/ads/library/?id={adId}`, with `target="_blank"` and `rel="noopener noreferrer"`. Style as `text-xs text-[var(--accent-green-light)] hover:text-[var(--text-primary)] transition-colors`. Display as a flex-wrap list with gap-2.
  - Show the ad ID as the link text (truncated to last 8 chars with full ID in title attribute for tooltip).

Include a local `formatReach` helper (same logic as in brand detail page: >=1M -> "X.XM", >=1K -> "X.XK", else toLocaleString).

**Second, create `src/components/dashboard/hook-explorer.tsx`:**

A client component ('use client') that renders the full hook exploration section.

Props interface:
```typescript
interface HookExplorerProps {
  hookGroups: HookGroupDisplay[];
  loading: boolean;
}

interface HookGroupDisplay {
  id: string;
  hookText: string;
  normalizedText: string;
  frequency: number;
  totalReach: number;
  avgReachPerAd: number;
  adIds: string[];
}
```

Export the `HookGroupDisplay` type so the parent page can use it.

Structure:
- Outer container: `glass rounded-2xl p-6` (matches existing section pattern)
- Header row (flex, items-center, justify-between, mb-4):
  - Left: h3 "Opening Hooks" with `text-lg font-semibold text-[var(--text-primary)]`
  - Right: hook count badge: `text-xs text-[var(--text-muted)]` showing "{filteredHooks.length} hooks"
- Search input (below header, mb-4): Copy the EXACT search pattern from `src/app/dashboard/page.tsx` lines 265-273. Use `Search` icon from lucide-react. Placeholder text: "Search hooks...". Full width (no sm:w-64 constraint -- this is inside a section, not a toolbar). Wire to `searchQuery` state.
- State: `useState<string>('')` for searchQuery, `useState<string | null>(null)` for expandedId.
- Filtering: `useMemo` that filters hookGroups by `hookText.toLowerCase().includes(searchQuery.toLowerCase().trim())`. If searchQuery is empty, return all. Import useMemo from React.
- Hook card list: `div className="space-y-2"` mapping over filteredHooks. Each renders a `<HookCard>` with `expanded={expandedId === hook.id}` and `onToggle={() => setExpandedId(prev => prev === hook.id ? null : hook.id)}`.
- Loading state: If `loading` is true, show 3 skeleton pulse divs (`h-16 bg-[var(--bg-tertiary)] rounded-lg animate-pulse`).
- Empty state (hookGroups.length === 0 AND not loading): Show `text-sm text-[var(--text-muted)] text-center py-8` with message "No opening hooks found. Re-analyze to extract hooks from ad creatives."
- No results from search (filteredHooks.length === 0 AND hookGroups.length > 0): Show `text-sm text-[var(--text-muted)] text-center py-4` with "No hooks match your search."
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors in both new files.
Verify HookCard renders ChevronDown, ad library links, formatReach.
Verify HookExplorer has search state, useMemo filter, loading skeleton, empty states.
  </verify>
  <done>
Both component files exist, type-check, and implement the card list with search filtering, expandable ad links, loading skeleton, and empty states.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire HookExplorer into brand detail page</name>
  <files>src/app/dashboard/[brandId]/page.tsx</files>
  <action>
Modify the brand detail page to fetch hook groups and render the HookExplorer component.

**Add imports** at the top:
```typescript
import { HookExplorer } from '@/components/dashboard/hook-explorer';
import type { HookGroupDisplay } from '@/components/dashboard/hook-explorer';
```

**Add state** (near the existing useState declarations, around line 17):
```typescript
const [hookGroups, setHookGroups] = useState<HookGroupDisplay[]>([]);
const [hooksLoading, setHooksLoading] = useState(false);
```

**Add fetchHooks callback** (near the existing fetchHistory callback, around line 20):
```typescript
const fetchHooks = useCallback(async (snapshotId: string) => {
  setHooksLoading(true);
  try {
    const res = await fetch(`/api/dashboard/hooks?snapshotId=${snapshotId}`);
    if (res.ok) {
      const json = await res.json();
      setHookGroups(json.hookGroups ?? []);
    }
  } catch {
    // silently fail -- hooks are non-critical
  } finally {
    setHooksLoading(false);
  }
}, []);
```

**Add useEffect to fetch hooks when snapshot is available.** The `snapshot` variable is derived at line 86 (`const snapshot = brand?.snapshots[0] ?? null`). Add a useEffect AFTER the existing useEffect for fetchHistory (around line 36):
```typescript
useEffect(() => {
  if (snapshot?.id) {
    fetchHooks(snapshot.id);
  }
}, [snapshot?.id, fetchHooks]);
```

**Re-fetch hooks after re-analyze.** In the `handleReanalyze` function, after `await fetchHistory(brand.id)` (around line 52), add:
```typescript
// Refresh will update brand.snapshots[0], triggering the useEffect above
// No explicit fetchHooks call needed -- the useEffect dependency on snapshot?.id handles it
```
Actually, since `refresh()` updates the brand data which changes `snapshot`, the useEffect will automatically re-trigger. No additional code needed in handleReanalyze. But verify this is the case -- if `snapshot.id` changes after re-analyze, the useEffect fires. If not (edge case where same brand object reference), add an explicit `fetchHooks` call after refresh. Safest approach: add the explicit call too:
```typescript
await refresh();
await fetchHistory(brand.id);
```
The useEffect will handle it since refresh() changes the snapshot reference.

**Render HookExplorer** in the JSX. Place it INSIDE the `<div className="space-y-6">` block (which starts at line 202), AFTER the country distribution section (which ends around line 291) and BEFORE the closing `</div>` of the space-y-6 block. This puts it above the History section.

```tsx
{/* Opening Hooks */}
<HookExplorer hookGroups={hookGroups} loading={hooksLoading} />
```

This goes at approximately line 291 (after the countries section closing div, before the space-y-6 closing div).

Do NOT move or modify existing sections.
Do NOT change the MetricBox or formatReach functions at the bottom of the file.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors.
Run `npm run build` to confirm the full app builds.
Check that HookExplorer appears in the JSX between country distribution and the end of the space-y-6 block.
Check that fetchHooks is called when snapshot.id is available.
  </verify>
  <done>
Brand detail page imports HookExplorer, fetches hook groups via the API when a snapshot is loaded, and renders the hook exploration section between country distribution and history. The app builds successfully.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Brand detail page shows Opening Hooks section with glass container
- Hook cards display hookText, frequency, totalReach
- Search input filters hooks by text content
- Clicking a hook card expands to show Facebook Ad Library links
- Empty state shown when no hook groups exist
- Loading skeleton shown while fetching
</verification>

<success_criteria>
- HOOK-04: Hook cards visible, sorted by totalReach descending (highest reach first)
- HOOK-05: Search input filters hook list by text content in real time
- HOOK-06: Expanding a hook card shows list of Facebook Ad Library links for each ad ID
- Empty state for snapshots without hooks guides user to re-analyze
- All existing brand detail page functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/29-hook-exploration-ui/29-02-SUMMARY.md`
</output>
