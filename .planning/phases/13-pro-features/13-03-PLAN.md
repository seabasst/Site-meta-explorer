---
phase: 13-pro-features
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/pdf-export.ts
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Pro user can click Export PDF and download a PDF report"
    - "PDF contains analysis summary, demographics, and ad list"
    - "Free user sees PDF export option as locked with upgrade CTA"
    - "Export dropdown shows both CSV (existing) and PDF (new) options"
  artifacts:
    - path: "src/lib/pdf-export.ts"
      provides: "PDF generation utility using jspdf + html2canvas"
      exports: ["exportToPDF"]
    - path: "src/app/page.tsx"
      provides: "PDF export option in export dropdown, gated by tier"
      contains: "exportToPDF"
  key_links:
    - from: "src/lib/pdf-export.ts"
      to: "jspdf"
      via: "dynamic import"
      pattern: "import\\('jspdf'\\)"
    - from: "src/app/page.tsx"
      to: "src/lib/pdf-export.ts"
      via: "import and call"
      pattern: "exportToPDF"
---

<objective>
Add PDF export capability for analysis results, gated behind Pro tier.

Purpose: Implements TIER-05 (Pro users can export analysis results as PDF).
Output: PDF export function + gated export option in UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-pro-features/13-RESEARCH.md

@src/lib/export-utils.ts
@src/app/page.tsx
@src/hooks/use-tier-access.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PDF dependencies and create export utility</name>
  <files>src/lib/pdf-export.ts</files>
  <action>
First install dependencies:
```bash
npm install jspdf html2canvas
npm install --save-dev @types/html2canvas
```

Then create src/lib/pdf-export.ts with:

1. Import types from facebook-api.ts (FacebookApiResult)

2. Create `exportToPDF` async function:
   - Parameters: `result: FacebookApiResult`, `elementId: string`
   - Returns: `Promise<void>`

3. Implementation approach (per research):
   - Use dynamic imports to avoid bundle bloat:
     ```typescript
     const jsPDF = (await import('jspdf')).default;
     const html2canvas = (await import('html2canvas')).default;
     ```
   - Get element by ID
   - Capture with html2canvas:
     ```typescript
     const canvas = await html2canvas(element, {
       scale: 2,  // 2x for better quality
       useCORS: true,
       logging: false,
       backgroundColor: '#1c1c0d',  // Match dark theme
       scrollX: 0,
       scrollY: -window.scrollY,
     });
     ```
   - Create PDF with jsPDF:
     - A4 size, portrait
     - Add image from canvas
     - Handle multi-page if content is tall
   - Save with filename: `{pageName}_analysis_{date}.pdf`

4. Handle errors gracefully:
   - Throw if element not found
   - Let jspdf/html2canvas errors propagate

Note: This is a simple "capture as image" approach. Text won't be searchable in PDF, but it captures the exact visual state including charts.
  </action>
  <verify>
Dependencies installed: `grep jspdf package.json`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
PDF export utility exists and can generate PDFs from DOM elements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add gated PDF export to page.tsx</name>
  <files>src/app/page.tsx</files>
  <action>
Add PDF export option to the existing Export dropdown, gated by tier.

Changes needed:

1. Add imports:
   ```typescript
   import { exportToPDF } from '@/lib/pdf-export';
   import { useTierAccess } from '@/hooks/use-tier-access';
   import { ProBadge } from '@/components/tier/pro-badge';
   ```

2. In the Home component, add tier access:
   ```typescript
   const { config: tierConfig, isLoading: tierLoading } = useTierAccess();
   ```

3. Add an ID to the results container for PDF capture:
   - Find the main results div (around line 527): `<div className="glass rounded-2xl p-6">`
   - Add `id="analysis-results"` to it

4. Modify the Export dropdown (around line 551-583):
   - Add PDF export option BEFORE existing CSV options
   - For Pro users: Button calls `exportToPDF(apiResult, 'analysis-results')`
   - For Free users: Button shows ProBadge and triggers checkout/signin on click

   Example structure for PDF option:
   ```tsx
   {tierConfig.features.export ? (
     <button
       onClick={() => exportToPDF(apiResult, 'analysis-results')}
       className="w-full px-4 py-2 text-left text-xs ..."
     >
       Full Report (PDF)
     </button>
   ) : (
     <button
       onClick={() => { /* signIn or checkout */ }}
       className="w-full px-4 py-2 text-left text-xs ... flex items-center justify-between"
     >
       <span>Full Report (PDF)</span>
       <ProBadge size="sm" />
     </button>
   )}
   ```

5. Add loading state during PDF generation:
   - Use useState for `isPdfExporting`
   - Show "Exporting..." text while generating
   - Disable button during export

6. Add error handling:
   - Wrap exportToPDF in try/catch
   - Show toast on error using existing sonner pattern
  </action>
  <verify>
Build passes: `npm run build`
PDF option appears in export dropdown
Pro badge shows for free users
  </verify>
  <done>
PDF export option in dropdown - Pro users can export, free users see locked option.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. jspdf and html2canvas are in package.json
3. PDF export function works (manual test with Pro account)
4. Export dropdown shows PDF option
5. Free users see ProBadge on PDF option
6. Pro users can successfully download PDF
</verification>

<success_criteria>
- PDF export produces readable report with analysis data
- Export is properly gated by tier
- Free users see upgrade path for PDF export
- No bundle size regression (dynamic imports used)
</success_criteria>

<output>
After completion, create `.planning/phases/13-pro-features/13-03-SUMMARY.md`
</output>
