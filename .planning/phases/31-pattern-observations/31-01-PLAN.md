---
phase: 31-pattern-observations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/observation-engine.ts
  - src/components/dashboard/observation-card.tsx
  - src/components/dashboard/observation-list.tsx
autonomous: true

must_haves:
  truths:
    - "generateObservations returns demographic skew observation when dominant age pct >= 25% and gender data exists"
    - "generateObservations returns gender imbalance observation when dominant gender pct > 60%"
    - "generateObservations returns geographic concentration observation when top 2 countries exceed 50% of reach"
    - "generateObservations returns hook pattern observation when top hook frequency >= 3 and total ads >= 5"
    - "generateObservations returns empty array when no thresholds are met"
    - "Observations are sorted by magnitude descending and capped at 5"
  artifacts:
    - path: "src/lib/observation-engine.ts"
      provides: "Pure function observation engine with 4 detectors"
      exports: ["generateObservations", "Observation", "ObservationType"]
    - path: "src/components/dashboard/observation-card.tsx"
      provides: "Single observation card component"
      exports: ["ObservationCard"]
    - path: "src/components/dashboard/observation-list.tsx"
      provides: "Container rendering up to 5 cards, returns null when empty"
      exports: ["ObservationList"]
  key_links:
    - from: "src/components/dashboard/observation-card.tsx"
      to: "src/lib/observation-engine.ts"
      via: "imports Observation type"
      pattern: "import.*Observation.*observation-engine"
    - from: "src/components/dashboard/observation-list.tsx"
      to: "src/components/dashboard/observation-card.tsx"
      via: "renders ObservationCard for each observation"
      pattern: "ObservationCard"
---

<objective>
Create the observation engine and card components for auto-generated pattern observations.

Purpose: Build the pure-function rule engine that detects demographic skew, gender imbalance, geographic concentration, and hook patterns from existing snapshot/hook data, plus the UI components to render them as cards.
Output: Three new files — observation-engine.ts, observation-card.tsx, observation-list.tsx
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-pattern-observations/31-RESEARCH.md

@src/hooks/use-tracked-brands.ts (TrackedBrandSnapshot type)
@src/components/dashboard/hook-explorer.tsx (HookGroupDisplay type)
@src/components/dashboard/hook-card.tsx (existing card styling reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create observation engine</name>
  <files>src/lib/observation-engine.ts</files>
  <action>
Create `src/lib/observation-engine.ts` as a pure function module. Follow the architecture from 31-RESEARCH.md closely:

1. Define types:
   - `ObservationType = 'demographic-skew' | 'gender-imbalance' | 'geo-concentration' | 'hook-pattern'`
   - `Observation { type, title, description, magnitude }`

2. Import types (not values) from existing modules:
   - `TrackedBrandSnapshot` from `@/hooks/use-tracked-brands`
   - `HookGroupDisplay` from `@/components/dashboard/hook-explorer`

3. Implement four detector functions, each returning `Observation | null`:

   **detectDemographicSkew(snapshot)**
   - Guard: return null if dominantAgeRange, dominantAgePct, dominantGender, or dominantGenderPct is null/undefined
   - Trigger: dominantAgePct >= 25
   - Description: `Skews {ageRange} {gender}, {pct}% of reach`
   - Magnitude: dominantAgePct value directly

   **detectGenderImbalance(snapshot)**
   - Guard: return null if dominantGender or dominantGenderPct is null/undefined
   - Trigger: dominantGenderPct > 60
   - Description: `{Gender} audience dominates at {pct}% of reach` (capitalize gender)
   - Magnitude: `(dominantGenderPct - 60) / 40 * 100`

   **detectGeoConcentration(snapshot)**
   - Guard: return null if topCountry1Code or topCountry1Pct is null/undefined
   - Trigger: topCountry1Pct + (topCountry2Pct ?? 0) > 50
   - Use `new Intl.DisplayNames(['en'], { type: 'region' })` to convert country codes to full names (e.g., "DE" -> "Germany")
   - If only one country in the concentration, show just that country
   - If two countries, show both
   - Description: `Concentrated in {country1} and {country2}, {combinedPct}% of reach`
   - Magnitude: combinedPct value

   **detectHookPattern(hookGroups, totalAds)**
   - Guard: return null if hookGroups is empty or totalAds < 5
   - Trigger: hookGroups[0].frequency >= 3 (hookGroups already sorted by totalReach desc from API)
   - Truncate hook text to 50 chars with "..." if longer
   - Description: `"{truncatedText}" appears in {frequency} ads`
   - Magnitude: `(frequency / totalAds) * 100`

4. Export `generateObservations(snapshot, hookGroups)`:
   - Call all four detectors
   - Collect non-null results
   - Sort by magnitude descending
   - Slice to max 5
   - Return the array

5. Helper: `capitalize(s: string)` for gender display

Important: Use `snapshot.totalAdsFound` (not `activeAdsCount`) for the hook pattern denominator, since totalAdsFound reflects all ads analyzed.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in observation-engine.ts. Verify the file exports generateObservations, Observation, and ObservationType.
  </verify>
  <done>
observation-engine.ts compiles cleanly. All four detector functions handle null guards. generateObservations returns sorted, capped array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create observation card components</name>
  <files>src/components/dashboard/observation-card.tsx, src/components/dashboard/observation-list.tsx</files>
  <action>
Create two components following the project's existing styling patterns (CSS variables, glass cards, Tailwind).

**observation-card.tsx:**
- Import `Observation` type from `@/lib/observation-engine`
- Import Lucide icons: `Users` (demographic-skew), `Scale` (gender-imbalance), `Globe` (geo-concentration), `MessageSquare` (hook-pattern)
- Create icon map: `Record<ObservationType, LucideIcon>`
- Render a compact card with:
  - Left: icon in a small circle with type-appropriate accent color background (use `bg-[var(--accent-green)]/10` for consistency)
  - Right: title (xs, uppercase, muted) + description (sm, primary text)
  - Use `flex items-start gap-3` layout
  - Background: `bg-[var(--bg-tertiary)] border border-[var(--border-subtle)] rounded-lg px-4 py-3`
- Export as named export `ObservationCard`

**observation-list.tsx:**
- Import `Observation` type from `@/lib/observation-engine`
- Import `ObservationCard` from `./observation-card`
- Props: `{ observations: Observation[] }`
- If observations array is empty, return `null` (OBSV-06: hidden when no patterns)
- Otherwise render:
  - Section header: "Key Observations" (xs, uppercase, muted, tracking-wider)
  - Cards in a `space-y-2` container
  - Key each card by `${obs.type}-${i}`
- Export as named export `ObservationList`

Both components should be client components ('use client' directive) since they render in a client component page.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Verify both files export their named components.
  </verify>
  <done>
ObservationCard renders individual observation with icon, title, and description. ObservationList renders up to 5 cards with section header, returns null when empty.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- observation-engine.ts exports generateObservations, Observation, ObservationType
- observation-card.tsx exports ObservationCard
- observation-list.tsx exports ObservationList
- ObservationList returns null for empty observations array (grep for `return null`)
</verification>

<success_criteria>
All three files created, type-check passes, observation engine implements all four OBSV detection rules with proper null guards and magnitude normalization.
</success_criteria>

<output>
After completion, create `.planning/phases/31-pattern-observations/31-01-SUMMARY.md`
</output>
