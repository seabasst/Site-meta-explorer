---
phase: 04-display
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can configure number of ads before starting scrape"
    - "User sees loading progress during demographic scraping"
    - "User sees text summary after scrape completes"
    - "User sees age/gender chart after scrape completes"
    - "User sees country chart after scrape completes"
  artifacts:
    - path: "src/app/page.tsx"
      provides: "Integrated demographics UI"
      contains: "AggregatedDemographics"
  key_links:
    - from: "src/app/page.tsx"
      to: "/api/scrape-ads"
      via: "fetch with scrapeDemographics and maxDemographicAds params"
      pattern: "scrapeDemographics.*true"
    - from: "src/app/page.tsx"
      to: "src/components/demographics/*.tsx"
      via: "import and render"
      pattern: "import.*from.*demographics"
---

<objective>
Integrate all demographics components into the main page with loading states and API wiring.

Purpose: Complete the display phase - users can configure, trigger, watch progress, and view demographic insights.
Output: Fully functional demographics display in the main application.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-display/04-RESEARCH.md

Files to modify:
@src/app/page.tsx

Type definitions:
@src/lib/demographic-types.ts

API endpoint:
@src/app/api/scrape-ads/route.ts

Components created in prior plans (04-01, 04-02):
- src/components/demographics/scrape-config.tsx
- src/components/demographics/demographics-summary.tsx
- src/components/demographics/age-gender-chart.tsx
- src/components/demographics/country-chart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add state and imports for demographics</name>
  <files>src/app/page.tsx</files>
  <action>
Add necessary imports and state variables for demographics display.

Add imports at top of file:
```typescript
import { AdLibraryResultWithDemographics, AggregatedDemographics } from '@/lib/demographic-types';
import { ScrapeConfig } from '@/components/demographics/scrape-config';
import { DemographicsSummary } from '@/components/demographics/demographics-summary';
import { AgeGenderChart } from '@/components/demographics/age-gender-chart';
import { CountryChart } from '@/components/demographics/country-chart';
```

Add state variables inside Home component (after existing state):
```typescript
// Demographics configuration
const [maxDemographicAds, setMaxDemographicAds] = useState(10);

// Demographics loading progress
const [demographicsProgress, setDemographicsProgress] = useState<{ current: number; total: number } | null>(null);
```

Note: adResult already exists and will be typed as AdLibraryResultWithDemographics when demographics are included.
  </action>
  <verify>
- Imports added at top of file
- New state variables declared
- `npx tsc --noEmit` passes
  </verify>
  <done>State and imports ready for demographics display</done>
</task>

<task type="auto">
  <name>Task 2: Update API call to include demographics options</name>
  <files>src/app/page.tsx</files>
  <action>
Modify handleAdLibrarySubmit to include demographics scraping options.

Update the fetch call body to include:
```typescript
body: JSON.stringify({
  adLibraryUrl: adLibraryUrl.trim(),
  scrapeDemographics: true,
  maxDemographicAds: maxDemographicAds,
}),
```

Before the fetch, set progress state:
```typescript
setDemographicsProgress({ current: 0, total: maxDemographicAds });
```

After response received, clear progress:
```typescript
setDemographicsProgress(null);
```

The response will now include aggregatedDemographics when demographics are successfully scraped.
  </action>
  <verify>
- fetch body includes scrapeDemographics: true
- fetch body includes maxDemographicAds
- Progress state is set before fetch and cleared after
  </verify>
  <done>API call sends demographics options and manages progress state</done>
</task>

<task type="auto">
  <name>Task 3: Add ScrapeConfig and loading progress to UI</name>
  <files>src/app/page.tsx</files>
  <action>
Add configuration input and loading progress display.

1. Add ScrapeConfig component inside the Ad Library form section, before the form submit button area.
   Place it below the input field, above the submit button:
```tsx
<ScrapeConfig
  maxAds={maxDemographicAds}
  onMaxAdsChange={setMaxDemographicAds}
  disabled={isLoadingAds}
/>
```

2. Update the loading state display (where isLoadingAds is true).
   Replace or enhance the existing loading message to show progress:
```tsx
{isLoadingAds && (
  <div className="mt-4 text-center py-4">
    <div className="inline-flex flex-col items-center gap-3">
      <LoadingSpinner size="lg" />
      <div className="text-center">
        <p className="text-[var(--text-primary)] font-medium">
          Analyzing demographics...
        </p>
        {demographicsProgress && (
          <p className="text-sm text-[var(--text-muted)] mt-1">
            {demographicsProgress.current} of {demographicsProgress.total} ads to process
          </p>
        )}
      </div>
    </div>
  </div>
)}
```
  </action>
  <verify>
- ScrapeConfig renders in the Ad Library section
- Loading state shows "Analyzing demographics..." with progress info
  </verify>
  <done>Configuration input visible and loading progress displays during scrape</done>
</task>

<task type="auto">
  <name>Task 4: Add demographics results display section</name>
  <files>src/app/page.tsx</files>
  <action>
Add demographics visualization section when aggregatedDemographics is available.

After the Ad Library results summary section (after the adResult checks), add a new section for demographics display.
Find the section that shows "Top advertised destinations" and add below it (but still inside the adResult conditional):

```tsx
{/* Demographics Results */}
{adResult && (adResult as AdLibraryResultWithDemographics).aggregatedDemographics && (
  <div className="mt-6 space-y-6">
    <h3 className="font-serif text-lg text-[var(--text-primary)]">
      Audience <span className="italic text-[var(--accent-green-light)]">Demographics</span>
    </h3>

    {/* Summary */}
    <div className="glass rounded-xl p-5">
      <h4 className="text-sm font-medium text-[var(--text-muted)] uppercase tracking-wide mb-3">
        Key Insights
      </h4>
      <DemographicsSummary
        demographics={(adResult as AdLibraryResultWithDemographics).aggregatedDemographics!}
      />
    </div>

    {/* Charts Grid */}
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Age/Gender Chart */}
      <div className="glass rounded-xl p-5">
        <h4 className="text-sm font-medium text-[var(--text-muted)] uppercase tracking-wide mb-3">
          Age & Gender Breakdown
        </h4>
        <AgeGenderChart
          data={(adResult as AdLibraryResultWithDemographics).aggregatedDemographics!.ageGenderBreakdown}
        />
      </div>

      {/* Country Chart */}
      <div className="glass rounded-xl p-5">
        <h4 className="text-sm font-medium text-[var(--text-muted)] uppercase tracking-wide mb-3">
          Geographic Distribution
        </h4>
        <CountryChart
          data={(adResult as AdLibraryResultWithDemographics).aggregatedDemographics!.regionBreakdown}
        />
      </div>
    </div>
  </div>
)}
```

This creates a responsive layout: summary at top, two charts in a grid below (stacked on mobile, side-by-side on large screens).
  </action>
  <verify>
- Demographics section renders when aggregatedDemographics exists
- Summary, AgeGenderChart, and CountryChart all render
- Layout is responsive (grid with lg:grid-cols-2)
  </verify>
  <done>Demographics visualizations display in organized layout when data is available</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete demographics display integration:
- Configuration input for number of ads to analyze
- Loading progress during demographic scraping
- Text summary with dominant gender and age range
- Stacked bar chart showing age/gender breakdown
- Pie chart showing country distribution
  </what-built>
  <how-to-verify>
1. Run `npm run dev` to start development server
2. Visit http://localhost:3000
3. Click an example brand (e.g., "Allbirds") to load sitemap
4. In the Ad Library section, verify:
   - "Ads to analyze" input is visible with value 10
   - Change value to 5 (should clamp between 1-50)
5. Paste or use pre-filled Ad Library URL and click "Scan Ads"
6. During scraping, verify:
   - Loading spinner shows
   - "Analyzing demographics..." text displays
   - Progress shows "0 of 5 ads to process"
7. After scrape completes, verify:
   - "Key Insights" section shows dominant gender % and ages 25-44 %
   - "Age & Gender Breakdown" shows stacked bar chart
   - "Geographic Distribution" shows pie chart with country labels
8. Resize browser to verify charts are responsive
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- `npm run dev` starts without errors
- All demographics UI elements render correctly
- API call includes scrapeDemographics: true and maxDemographicAds
- Charts render with real data from API response
</verification>

<success_criteria>
1. User can set ads to analyze (1-50 range enforced)
2. Loading state shows progress during scrape (DISP-04, RELY-03)
3. Text summary shows dominant gender % and ages 25-44 % (DISP-01)
4. Age/gender bar chart renders with stacked bars (DISP-02)
5. Country pie chart renders with top 5 + Other (DISP-03)
6. All charts are responsive to viewport size
</success_criteria>

<output>
After completion, create `.planning/phases/04-display/04-03-SUMMARY.md`
</output>
