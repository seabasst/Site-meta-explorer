---
phase: 17.1-export-filter-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/page.tsx
  - src/components/demographics/country-chart.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "PDF export renders all ads regardless of active chart filter"
    - "Mobile users see export progress text on the Export button while PDF generates"
    - "Country chart tooltip stays fully visible on 375px viewports"
  artifacts:
    - path: "src/app/page.tsx"
      provides: "Unfiltered ad table during export, mobile progress on button"
      contains: "isExporting ? apiResult.ads : filteredAds"
    - path: "src/components/demographics/country-chart.tsx"
      provides: "Safe tooltip positioning for narrow viewports"
  key_links:
    - from: "src/app/page.tsx (ad table)"
      to: "isExporting state"
      via: "conditional data source in .map()"
      pattern: "isExporting.*apiResult\\.ads.*filteredAds"
    - from: "src/app/page.tsx (Export button)"
      to: "isPdfExporting + pdfProgress state"
      via: "progress text rendered on button element"
      pattern: "isPdfExporting.*pdfProgress"
---

<objective>
Fix three integration gaps found during the v2.1 milestone audit: (1) PDF export showing filtered ad data when a chart filter is active, (2) no export progress visible on mobile devices, and (3) country chart tooltip overflowing on narrow screens.

Purpose: Close all integration gaps from v2.1-MILESTONE-AUDIT.md so the milestone ships clean.
Output: Two modified source files with all three fixes applied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v2.1-MILESTONE-AUDIT.md
@src/app/page.tsx
@src/components/demographics/country-chart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Use unfiltered ads in PDF export and show mobile progress</name>
  <files>src/app/page.tsx</files>
  <action>
Two changes in page.tsx:

**Fix 1 - Unfiltered PDF ad table (line ~1517):**
Change the ad table `.map()` from always using `filteredAds` to conditionally using unfiltered data during export:
```
{(isExporting ? apiResult.ads : filteredAds).map((ad, index) => (
```
This ensures the PDF always contains all ads, even when a chart filter is active. The filter pill is already hidden via `data-pdf-hide`, so now the data matches.

Also update the "(showing N)" count indicator on line ~1500 to hide during export â€” it would be confusing in the PDF since we show all ads:
```
{chartFilter && !isExporting && filteredAds.length !== apiResult.ads.length && (
```

**Fix 2 - Mobile export progress on button (lines ~949-958):**
Change the Export button text content (inside the button element at line ~957) to show progress when `isPdfExporting` is true. Replace the static "Export" text:

From:
```
Export
```

To:
```
{isPdfExporting && pdfProgress ? pdfProgress.step : isPdfExporting ? 'Exporting...' : 'Export'}
```

This shows progress directly on the always-visible button, not just inside the dropdown. The dropdown menu item (line ~992) can keep its existing progress text for desktop hover users.
  </action>
  <verify>
1. `npx next build` completes without errors
2. Grep for `isExporting ? apiResult.ads : filteredAds` confirms the conditional data source
3. Grep for `isPdfExporting.*pdfProgress.*Export` confirms progress text on the button
  </verify>
  <done>
- Ad table uses `apiResult.ads` (unfiltered) when `isExporting` is true, `filteredAds` otherwise
- "(showing N)" count hidden during export
- Export button shows progress step text while PDF is generating
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix country chart tooltip positioning for narrow viewports</name>
  <files>src/components/demographics/country-chart.tsx</files>
  <action>
Change the tooltip positioning on line ~173 from fixed `left-36` to a responsive value that works on both mobile and desktop.

The label column is `w-20` (80px) on mobile and `w-36` (144px) on sm+. The tooltip at `left-36` (144px) overflows when the label column is only 80px wide.

Replace:
```
className="absolute -top-12 left-36 z-20 ...
```

With:
```
className="absolute -top-12 left-20 sm:left-36 z-20 ...
```

This aligns the tooltip to the right edge of the label column at each breakpoint: `left-20` (80px) on mobile matches `w-20`, and `left-36` (144px) on sm+ matches `w-36`.
  </action>
  <verify>
1. Grep for `left-20 sm:left-36` in country-chart.tsx confirms responsive positioning
2. `npx next build` completes without errors
  </verify>
  <done>
- Tooltip uses `left-20` on mobile and `left-36` on sm+, matching the responsive label column widths
- No horizontal overflow on 375px viewports
  </done>
</task>

</tasks>

<verification>
All three audit gaps closed:
1. `grep -n "isExporting.*apiResult\.ads.*filteredAds" src/app/page.tsx` returns match
2. `grep -n "isPdfExporting.*pdfProgress" src/app/page.tsx` returns match on the Export button (not just dropdown)
3. `grep -n "left-20 sm:left-36" src/components/demographics/country-chart.tsx` returns match
4. `npx next build` passes with no errors
</verification>

<success_criteria>
- PDF export always includes all ads (unfiltered) regardless of active chart filter
- Mobile users see export progress text on the Export button while PDF generates
- Country chart tooltip stays on-screen at 375px viewport width
- No build errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/17.1-export-filter-fix/17.1-01-SUMMARY.md`
</output>
