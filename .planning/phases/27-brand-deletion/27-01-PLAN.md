---
phase: 27-brand-deletion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/alert-dialog.tsx
  - src/components/dashboard/delete-brand-dialog.tsx
  - src/components/dashboard/competitor-card.tsx
  - src/components/dashboard/own-brand-card.tsx
  - src/app/dashboard/page.tsx
  - src/app/dashboard/[brandId]/page.tsx
  - src/app/api/dashboard/competitors/route.ts
autonomous: true

must_haves:
  truths:
    - "User can delete a single competitor from the dashboard with confirmation"
    - "User can delete own brand from the dashboard with confirmation"
    - "User can delete a brand from the brand detail page with confirmation"
    - "User can select multiple competitors and bulk delete them"
    - "Confirmation dialog appears before any deletion occurs"
    - "Dashboard updates immediately after deletion"
  artifacts:
    - path: "src/components/ui/alert-dialog.tsx"
      provides: "shadcn AlertDialog primitive"
    - path: "src/components/dashboard/delete-brand-dialog.tsx"
      provides: "Reusable confirmation dialog for brand deletion"
      exports: ["DeleteBrandDialog"]
    - path: "src/app/api/dashboard/competitors/route.ts"
      provides: "Bulk DELETE support via ids query param"
    - path: "src/app/dashboard/page.tsx"
      provides: "Bulk selection mode with checkboxes and bulk delete button"
  key_links:
    - from: "src/components/dashboard/delete-brand-dialog.tsx"
      to: "src/components/ui/alert-dialog.tsx"
      via: "import AlertDialog components"
      pattern: "from.*alert-dialog"
    - from: "src/components/dashboard/competitor-card.tsx"
      to: "src/components/dashboard/delete-brand-dialog.tsx"
      via: "Remove button opens DeleteBrandDialog"
      pattern: "DeleteBrandDialog"
    - from: "src/app/dashboard/page.tsx"
      to: "/api/dashboard/competitors"
      via: "Bulk delete fetch with ids param"
      pattern: "fetch.*competitors.*DELETE"
---

<objective>
Add brand deletion with confirmation dialogs and bulk selection to the dashboard.

Purpose: Complete DEL-01, DEL-02, DEL-03 requirements — users need to manage saved brands by removing ones they no longer want to track, with safeguards against accidental deletion and efficiency for removing multiple brands at once.

Output: Confirmation dialog on all delete actions, delete button on brand detail page, bulk selection mode on competitors grid with select-all and bulk delete.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@prisma/schema.prisma
@src/hooks/use-tracked-brands.ts
@src/app/dashboard/page.tsx
@src/app/dashboard/[brandId]/page.tsx
@src/components/dashboard/competitor-card.tsx
@src/components/dashboard/own-brand-card.tsx
@src/app/api/dashboard/competitors/route.ts
@src/app/api/dashboard/own-brand/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AlertDialog, create DeleteBrandDialog, add bulk DELETE endpoint</name>
  <files>
    src/components/ui/alert-dialog.tsx
    src/components/dashboard/delete-brand-dialog.tsx
    src/app/api/dashboard/competitors/route.ts
  </files>
  <action>
    1. Install shadcn AlertDialog component:
       Run `npx shadcn@latest add alert-dialog` to generate `src/components/ui/alert-dialog.tsx`.

    2. Create `src/components/dashboard/delete-brand-dialog.tsx` — a reusable confirmation dialog:
       - Props: `{ open: boolean; onOpenChange: (open: boolean) => void; brandName: string; onConfirm: () => void; loading?: boolean; count?: number }`
       - When `count` > 1, show "Delete {count} brands?" in the title; otherwise show "Delete {brandName}?"
       - Description: "This will permanently remove the brand and all its analysis history. This action cannot be undone."
       - When count > 1: "This will permanently remove {count} brands and all their analysis history. This action cannot be undone."
       - Cancel button and red destructive Confirm button ("Delete" / "Deleting...")
       - Use AlertDialog, AlertDialogContent, AlertDialogHeader, AlertDialogTitle, AlertDialogDescription, AlertDialogFooter, AlertDialogCancel, AlertDialogAction from the shadcn primitive.
       - Style the confirm button with `className="bg-red-600 hover:bg-red-700 text-white"`.

    3. Update the existing DELETE handler in `src/app/api/dashboard/competitors/route.ts` to support bulk deletion:
       - Keep existing single-id behavior: `?id=xxx` deletes one competitor.
       - Add bulk support: `?ids=xxx,yyy,zzz` deletes multiple competitors.
       - Parse: if `ids` param exists, split by comma into array; otherwise fall back to single `id` param.
       - Use `prisma.trackedBrand.deleteMany({ where: { id: { in: idArray }, trackerId: session.user.id } })` for bulk.
       - Return `{ success: true, deleted: count }` where count is the deleteMany result count.
  </action>
  <verify>
    - `ls src/components/ui/alert-dialog.tsx` exists
    - `src/components/dashboard/delete-brand-dialog.tsx` exports DeleteBrandDialog
    - TypeScript compiles: `npx tsc --noEmit --pretty 2>&1 | head -20`
  </verify>
  <done>
    AlertDialog primitive installed, reusable DeleteBrandDialog component created, competitors API supports both single and bulk DELETE via query params.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire deletion UI into dashboard, cards, and detail page</name>
  <files>
    src/components/dashboard/competitor-card.tsx
    src/components/dashboard/own-brand-card.tsx
    src/app/dashboard/page.tsx
    src/app/dashboard/[brandId]/page.tsx
  </files>
  <action>
    1. Update `src/components/dashboard/competitor-card.tsx`:
       - Import DeleteBrandDialog.
       - Add local state `const [deleteOpen, setDeleteOpen] = useState(false)`.
       - Change the existing "Remove" button's onClick to `setDeleteOpen(true)` instead of directly calling `onRemove`.
       - Add a `selectable` prop (boolean) and `selected` prop (boolean) and `onSelect` prop (callback).
       - When `selectable` is true, show a checkbox (styled div with checkmark) at the top-left of the card. Clicking the checkbox calls `onSelect`. The checkbox click area must stopPropagation to prevent Link navigation.
       - When `selected` is true, add a ring/border highlight: `ring-2 ring-[var(--accent-green)]`.
       - Render `<DeleteBrandDialog open={deleteOpen} onOpenChange={setDeleteOpen} brandName={competitor.pageName} onConfirm={() => { onRemove(); setDeleteOpen(false); }} />` inside the component.

    2. Update `src/components/dashboard/own-brand-card.tsx`:
       - Read the current file first to understand its structure.
       - Import DeleteBrandDialog.
       - Add an `onDelete` prop (optional callback). Add local state for dialog open.
       - Add a small "Delete" button (red text, same style as competitor card remove button) next to the existing action buttons. Only show if `onDelete` prop is provided.
       - Render DeleteBrandDialog with the own brand name, wired to `onDelete`.

    3. Update `src/app/dashboard/page.tsx` — add bulk selection mode and wire delete handlers:
       - Add state: `const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set())` and `const [selectMode, setSelectMode] = useState(false)`.
       - Add state: `const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false)` and `const [deleteLoading, setDeleteLoading] = useState(false)`.
       - Add `handleDeleteOwnBrand` callback: `fetch('/api/dashboard/own-brand', { method: 'DELETE' })` then `toast.success('Brand deleted')` then `refresh()`.
       - Add `handleBulkDelete` callback:
         - Set deleteLoading true.
         - `const ids = Array.from(selectedIds).join(',')`.
         - `fetch(`/api/dashboard/competitors?ids=${ids}`, { method: 'DELETE' })`.
         - On success: `toast.success(`Deleted ${selectedIds.size} brand(s)`)`, `setSelectedIds(new Set())`, `setSelectMode(false)`, `refresh()`.
         - On error: `toast.error('Failed to delete brands')`.
         - Finally: `setDeleteLoading(false)`, `setBulkDeleteOpen(false)`.
       - Add `toggleSelect(id: string)` helper that adds/removes from selectedIds set.
       - Add `selectAll` helper that adds all filteredCompetitor ids, and `deselectAll` that clears the set.
       - In the Competitors header area (next to "Add Competitor" button), add a "Select" toggle button. When `selectMode` is true, show "Cancel" instead.
       - When `selectMode` is true and `selectedIds.size > 0`, show a "Delete Selected ({count})" red button that opens the bulk DeleteBrandDialog.
       - When `selectMode` is true and competitors exist, show a "Select All" / "Deselect All" toggle link.
       - Pass `selectable={selectMode}`, `selected={selectedIds.has(c.id)}`, `onSelect={() => toggleSelect(c.id)}` to each CompetitorCard.
       - Pass `onDelete={handleDeleteOwnBrand}` to OwnBrandCard.
       - Import DeleteBrandDialog for the bulk delete dialog. Render it with `count={selectedIds.size}`.
       - When exiting select mode (Cancel button), also clear selectedIds.

    4. Update `src/app/dashboard/[brandId]/page.tsx` — add delete button:
       - Import DeleteBrandDialog and `useRouter` from `next/navigation`.
       - Add state for delete dialog open and delete loading.
       - Add `handleDelete` callback:
         - Determine if this is own brand (`data?.ownBrand?.id === brandId`) or competitor.
         - For own brand: `fetch('/api/dashboard/own-brand', { method: 'DELETE' })`.
         - For competitor: `fetch(`/api/dashboard/competitors?id=${brandId}`, { method: 'DELETE' })`.
         - On success: `toast.success('Brand deleted')`, `router.push('/dashboard')`.
         - On error: `toast.error('Failed to delete brand')`.
       - Add a "Delete Brand" button (red text, small) next to the "Re-analyze" button in the header.
       - Render DeleteBrandDialog wired to handleDelete.
  </action>
  <verify>
    - `npx tsc --noEmit --pretty 2>&1 | head -30` — no type errors
    - `npm run build 2>&1 | tail -20` — builds successfully
    - Visually: competitor cards show Remove button that opens confirmation, own brand card has Delete option, brand detail page has Delete button, select mode shows checkboxes on competitor cards
  </verify>
  <done>
    - Competitor card "Remove" button opens confirmation dialog before deletion (DEL-02)
    - Own brand card has delete with confirmation (DEL-01, DEL-02)
    - Brand detail page has delete with confirmation and redirects to dashboard (DEL-01, DEL-02)
    - Dashboard has bulk selection mode: Select toggle, checkboxes on cards, Select All/Deselect All, bulk Delete Selected button with confirmation (DEL-03)
    - All deletions refresh dashboard data after completion
  </done>
</task>

</tasks>

<verification>
1. Single competitor delete: Click "Remove" on a competitor card -> confirmation dialog appears -> confirm -> card disappears, toast shows success
2. Own brand delete: Click "Delete" on own brand card -> confirmation dialog -> confirm -> own brand section resets to setup state
3. Brand detail delete: On /dashboard/[id] -> click "Delete Brand" -> confirmation -> redirected to /dashboard, brand gone
4. Bulk delete: Click "Select" -> checkboxes appear on competitor cards -> select 2+ cards -> "Delete Selected (N)" button appears -> click -> confirmation with count -> confirm -> selected cards removed
5. Select All: In select mode, "Select All" selects all filtered competitors; "Deselect All" clears selection
6. Cancel without confirming: Dialog cancel button returns to previous state, no deletion occurs
7. `npm run build` passes with no errors
</verification>

<success_criteria>
- DEL-01: User can delete any brand (own or competitor) from dashboard or detail page
- DEL-02: Every delete action shows confirmation dialog before executing
- DEL-03: User can enter select mode, check multiple competitors, and bulk delete with single confirmation
- All deletions cascade to remove associated BrandSnapshots (handled by Prisma schema)
- Dashboard refreshes after deletion to reflect changes
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-brand-deletion/27-01-SUMMARY.md`
</output>
