---
phase: 30-brand-comparison
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - src/app/dashboard/compare/page.tsx
  - src/components/comparison/brand-selector.tsx
  - src/components/comparison/comparison-empty.tsx
  - src/app/dashboard/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /dashboard/compare and see the comparison page"
    - "User can select 2 saved brands from dropdown selectors"
    - "User sees butterfly chart, country chart, and metrics table for selected brands"
    - "User sees empty state with guidance when fewer than 2 brands are saved"
    - "User can reach comparison page from dashboard via Compare button"
  artifacts:
    - path: "src/app/dashboard/compare/page.tsx"
      provides: "Comparison page composing all comparison components"
      min_lines: 60
    - path: "src/components/comparison/brand-selector.tsx"
      provides: "Dual brand picker with two dropdowns"
      exports: ["BrandSelector"]
    - path: "src/components/comparison/comparison-empty.tsx"
      provides: "Empty state when fewer than 2 brands available"
      exports: ["ComparisonEmpty"]
  key_links:
    - from: "src/app/dashboard/compare/page.tsx"
      to: "@/hooks/use-tracked-brands"
      via: "useTrackedBrands hook for data"
      pattern: "useTrackedBrands"
    - from: "src/app/dashboard/compare/page.tsx"
      to: "src/components/comparison/butterfly-chart.tsx"
      via: "import and render"
      pattern: "ButterflyChart"
    - from: "src/app/dashboard/compare/page.tsx"
      to: "next/navigation"
      via: "useSearchParams for brand selection state"
      pattern: "useSearchParams"
    - from: "src/app/dashboard/page.tsx"
      to: "/dashboard/compare"
      via: "Compare button/link"
      pattern: "dashboard/compare"
---

<objective>
Create the comparison page at `/dashboard/compare` with brand selector, empty state, and wire all three chart/table components from Plan 01. Add a Compare button to the main dashboard page.

Purpose: This completes the brand comparison feature (COMP-01 through COMP-05) by composing the visualization components into a functional page with brand selection via URL params.
Output: Working comparison page accessible from the dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-brand-comparison/30-RESEARCH.md
@.planning/phases/30-brand-comparison/30-01-SUMMARY.md

@src/hooks/use-tracked-brands.ts
@src/app/dashboard/page.tsx
@src/components/dashboard/comparison-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrandSelector, ComparisonEmpty, and comparison page</name>
  <files>src/components/comparison/brand-selector.tsx, src/components/comparison/comparison-empty.tsx, src/app/dashboard/compare/page.tsx</files>
  <action>
Create `src/components/comparison/brand-selector.tsx`:

1. Accept props: `brands: TrackedBrand[]`, `selectedAId: string | null`, `selectedBId: string | null`, `onSelectA: (id: string) => void`, `onSelectB: (id: string) => void`.
2. Filter `brands` to only those with `snapshots.length > 0` (eligible for comparison).
3. Render two `<select>` dropdowns side by side (flex row, gap-4):
   - Left: "Brand A" label above, placeholder "Select brand...", options filtered to exclude `selectedBId`.
   - Right: "Brand B" label above, placeholder "Select brand...", options filtered to exclude `selectedAId`.
4. Each option shows `brand.pageName`.
5. Style selects with dark theme: `bg-[var(--bg-secondary)] border border-[var(--border-subtle)] rounded-lg px-3 py-2 text-sm text-[var(--text-primary)]`. Use `w-full` within a flex container.
6. Add a swap button between the two dropdowns (ArrowLeftRight icon from lucide-react) that swaps the two selections.
7. `'use client'` directive.

Create `src/components/comparison/comparison-empty.tsx`:

1. Accept props: `brandCount: number` (how many eligible brands exist).
2. If `brandCount === 0`: Show message "No brands saved yet. Save brands from analysis results to compare them." with a link to `/` (analyze page).
3. If `brandCount === 1`: Show message "You need at least 2 saved brands to compare. Save another brand to get started." with a link to `/` (analyze page).
4. Style: centered, glass card, muted icon (Scale from lucide-react), subtle text. Match empty state patterns from existing components (see country-chart.tsx empty state pattern).
5. `'use client'` directive.

Create `src/app/dashboard/compare/page.tsx`:

1. `'use client'` directive.
2. Import and use `useTrackedBrands` to get brand data.
3. Import `useSearchParams` and `useRouter` from `next/navigation`.
4. Read brand IDs from URL params: `searchParams.get('a')` and `searchParams.get('b')`.
5. Compute `allBrands = [...(data?.ownBrand ? [data.ownBrand] : []), ...(data?.competitors ?? [])]`.
6. Compute `eligibleBrands = allBrands.filter(b => b.snapshots.length > 0)`.
7. If `eligibleBrands.length < 2`, render `<ComparisonEmpty brandCount={eligibleBrands.length} />`.
8. When user selects brands via BrandSelector, update URL params using `router.replace()`:
   ```
   const params = new URLSearchParams(searchParams.toString());
   params.set('a', id);  // or 'b'
   router.replace(`/dashboard/compare?${params.toString()}`);
   ```
9. Find selected brands from allBrands by ID. Extract `demographicsJson` from latest snapshot, parse if string (see research Pattern 4).
10. Layout the page:
    - Page title: "Brand Comparison" with a back link to `/dashboard`.
    - BrandSelector at the top.
    - If both brands selected, show in order:
      a. MetricsTable (full width)
      b. ButterflyChart in a glass card with heading "Age & Gender Distribution"
      c. CountryComparison in a glass card with heading "Geographic Distribution"
    - If only one or zero brands selected (but 2+ eligible), show subtle prompt: "Select two brands above to compare."
11. Wrap the page content in Suspense with a fallback (needed for useSearchParams).
12. Style consistently with dashboard page: dark theme, glass cards, var(--text-primary/secondary/muted), padding, responsive layout.
13. Show loading state while `useTrackedBrands` is loading (simple "Loading..." or skeleton).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Start dev server with `npm run dev` and navigate to `http://localhost:3000/dashboard/compare` — should show empty state or brand selector depending on saved brands.
  </verify>
  <done>Comparison page renders at /dashboard/compare. Brand selector shows eligible brands in two dropdowns. Selecting two brands displays butterfly chart, country comparison, and metrics table. URL params persist selection. Empty state shows when fewer than 2 brands exist.</done>
</task>

<task type="auto">
  <name>Task 2: Add Compare button to dashboard page</name>
  <files>src/app/dashboard/page.tsx</files>
  <action>
Add a "Compare Brands" button/link to the main dashboard page (`src/app/dashboard/page.tsx`):

1. Import `Link` from `next/link` (if not already imported) and `Scale` icon from `lucide-react`.
2. Find the section where the ComparisonTable is rendered (around where `<ComparisonTable>` is used).
3. Add a Link button near the ComparisonTable section or in the dashboard header area:
   ```tsx
   <Link
     href="/dashboard/compare"
     className="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-subtle)] text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:border-[var(--accent-green)] transition-colors"
   >
     <Scale className="w-4 h-4" />
     Compare Brands
   </Link>
   ```
4. Only show the button when there are 2+ brands with snapshots (same eligibility check: ownBrand + competitors with snapshots >= 2).
5. Position it naturally — either next to the "Side-by-Side Comparison" heading in the ComparisonTable area, or as a standalone action button in the dashboard toolbar area.
  </action>
  <verify>
Run `npx tsc --noEmit`. Navigate to dashboard page and confirm the "Compare Brands" link appears and navigates to `/dashboard/compare`.
  </verify>
  <done>Dashboard page has a visible "Compare Brands" link that navigates to /dashboard/compare. Link only appears when 2+ eligible brands exist.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete brand comparison feature: comparison page at /dashboard/compare with butterfly chart (age-gender), country comparison chart, metrics table, brand selector with URL params, empty state, and Compare button on dashboard.</what-built>
  <how-to-verify>
1. Go to http://localhost:3000/dashboard
2. Confirm "Compare Brands" button appears (if you have 2+ saved brands with snapshots)
3. Click "Compare Brands" — should navigate to /dashboard/compare
4. Select two brands from the dropdowns
5. Verify butterfly chart shows age-gender data (Brand A extends left, Brand B extends right)
6. Verify country comparison shows paired horizontal bars
7. Verify metrics table shows side-by-side summary data
8. Try the swap button between brand selectors
9. Refresh the page — brand selection should persist via URL params
10. If you have fewer than 2 brands, verify the empty state shows with guidance
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `/dashboard/compare` page renders correctly
- Brand selector shows eligible brands, excludes already-selected brand from other dropdown
- Butterfly chart uses Recharts with negative values for Brand A
- Country comparison shows merged top 8 countries with paired bars
- Metrics table shows formatted values from latest snapshots
- Empty state renders when fewer than 2 eligible brands
- Dashboard page has Compare button linking to comparison page
- URL params (`?a=id1&b=id2`) persist brand selection across page refresh
</verification>

<success_criteria>
All five COMP requirements are satisfied:
- COMP-01: User selects 2 brands via dropdown selectors
- COMP-02: Butterfly chart shows age-gender distribution
- COMP-03: Paired horizontal bars show country distribution
- COMP-04: Metrics table shows summary data side by side
- COMP-05: Empty state with guidance when fewer than 2 brands saved
</success_criteria>

<output>
After completion, create `.planning/phases/30-brand-comparison/30-02-SUMMARY.md`
</output>
