---
phase: 30-brand-comparison
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/comparison/butterfly-chart.tsx
  - src/components/comparison/country-comparison.tsx
  - src/components/comparison/metrics-table.tsx
autonomous: true

must_haves:
  truths:
    - "Butterfly chart renders age-gender data for two brands with Brand A extending left and Brand B extending right"
    - "Country comparison chart renders paired horizontal bars for two brands"
    - "Metrics table renders side-by-side summary metrics for two brands"
  artifacts:
    - path: "src/components/comparison/butterfly-chart.tsx"
      provides: "Age-gender butterfly chart using Recharts BarChart with negative values for Brand A"
      exports: ["ButterflyChart"]
    - path: "src/components/comparison/country-comparison.tsx"
      provides: "Paired horizontal bar chart for country distribution comparison"
      exports: ["CountryComparison"]
    - path: "src/components/comparison/metrics-table.tsx"
      provides: "Summary metrics table with reach, ad count, dominant demographic"
      exports: ["MetricsTable"]
  key_links:
    - from: "src/components/comparison/butterfly-chart.tsx"
      to: "recharts"
      via: "BarChart with layout=vertical and negative values"
      pattern: "BarChart.*layout.*vertical"
    - from: "src/components/comparison/country-comparison.tsx"
      to: "recharts"
      via: "BarChart with paired bars"
      pattern: "BarChart.*layout.*vertical"
---

<objective>
Create the three data visualization components for brand comparison: butterfly chart (age-gender), country comparison chart, and metrics table.

Purpose: These are the core visual building blocks that the comparison page will compose. Building them standalone first keeps each component focused and testable.
Output: Three React components in `src/components/comparison/` ready for import by the comparison page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-brand-comparison/30-RESEARCH.md

@src/hooks/use-tracked-brands.ts
@src/components/dashboard/trend-chart.tsx
@src/components/demographics/age-gender-chart.tsx
@src/components/demographics/country-chart.tsx
@src/components/dashboard/comparison-table.tsx
@src/lib/demographic-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ButterflyChart and CountryComparison components</name>
  <files>src/components/comparison/butterfly-chart.tsx, src/components/comparison/country-comparison.tsx</files>
  <action>
Create `src/components/comparison/butterfly-chart.tsx`:

1. Accept props: `brandAName: string`, `brandBName: string`, `brandADemo: AggregatedDemographics | null`, `brandBDemo: AggregatedDemographics | null`.
2. Use the `AggregatedDemographics` interface shape from `src/lib/demographic-types.ts` (import or re-declare the subset needed: `ageGenderBreakdown: { age: string; gender: string; percentage: number }[]`).
3. Build butterfly data using the pattern from 30-RESEARCH.md:
   - Use `AGE_ORDER = ['13-17', '18-24', '25-34', '35-44', '45-54', '55-64', '65+']` (same as age-gender-chart.tsx).
   - Brand A values negated (extend left), Brand B values positive (extend right).
   - Map over AGE_ORDER, defaulting missing entries to 0.
4. Render using Recharts `BarChart` with `layout="vertical"`:
   - `XAxis type="number"` with `tickFormatter={(v) => Math.abs(v).toFixed(1) + '%'}` and `domain={['auto', 'auto']}`.
   - `YAxis type="category" dataKey="age"` with width 50.
   - Four `Bar` components: `brandA_male` (blue-600, stackId="a"), `brandA_female` (rose-500, stackId="a"), `brandB_male` (blue-400, stackId="b"), `brandB_female` (rose-300, stackId="b").
   - Use `stackOffset="sign"` on BarChart.
   - Wrap in `ResponsiveContainer width="100%" height={320}`.
   - Add `Tooltip` with custom `formatter` that shows `Math.abs(value).toFixed(1) + '%'` and labels like "Brand A Male", "Brand B Female".
   - Add `Legend` showing brand names and gender colors.
5. Show "No demographic data available" message when both brands have null demographics.
6. Use `'use client'` directive. Match styling conventions from existing dashboard components (glass cards, CSS variables).

Create `src/components/comparison/country-comparison.tsx`:

1. Accept props: `brandAName: string`, `brandBName: string`, `brandADemo: AggregatedDemographics | null`, `brandBDemo: AggregatedDemographics | null`.
2. Extract `regionBreakdown` from each brand's demographics.
3. Merge countries from both brands into a unified list:
   - Create union of all countries from both brands.
   - Take top 8 by combined percentage, group rest as "Other".
   - Each entry: `{ country: string, brandA: number, brandB: number }`.
4. Use `COUNTRY_NAMES` mapping from `src/components/demographics/country-chart.tsx` — import or duplicate the subset needed to convert country codes to readable names.
5. Render using Recharts `BarChart` with `layout="vertical"`:
   - `XAxis type="number"` with `tickFormatter={(v) => v.toFixed(1) + '%'}`.
   - `YAxis type="category" dataKey="country"` with width 80.
   - Two `Bar` components: `brandA` (var(--accent-green) or emerald-500), `brandB` (amber-500).
   - Wrap in `ResponsiveContainer width="100%" height` calculated as `Math.max(280, mergedCountries.length * 45)`.
   - Add `Tooltip` and `Legend` with brand names.
6. Show "No geographic data available" when both brands lack region data.
7. Use `'use client'` directive.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Visually inspect that both files export named components and import from recharts correctly.
  </verify>
  <done>ButterflyChart renders a vertical BarChart with negative Brand A values and positive Brand B values across age ranges. CountryComparison renders paired horizontal bars for top 8 countries merged from both brands. Both handle null demographics gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Create MetricsTable component</name>
  <files>src/components/comparison/metrics-table.tsx</files>
  <action>
Create `src/components/comparison/metrics-table.tsx`:

1. Accept props: `brandA: TrackedBrand | null`, `brandB: TrackedBrand | null` (import `TrackedBrand` from `@/hooks/use-tracked-brands`).
2. Define metrics rows (reuse the pattern from `src/components/dashboard/comparison-table.tsx`):
   - Active Ads: `activeAdsCount.toLocaleString()`
   - Total Reach: format with K/M suffixes (write a local `formatReach` helper or import pattern)
   - Est. Spend: `$${Math.round(estimatedSpendUsd).toLocaleString()}`
   - Dominant Gender: `dominantGender (dominantGenderPct%)`
   - Top Age Range: `dominantAgeRange (dominantAgePct%)`
   - Top Country: `topCountry1Code (topCountry1Pct%)`
   - Video %: `videoPercentage.toFixed(1)%`
   - Avg Ad Age: `Math.round(avgAdAgeDays) days`
3. Render as a table with 3 columns: Metric | Brand A Name | Brand B Name.
4. Use the latest snapshot from each brand (`brand.snapshots[0]`).
5. Show dash "—" for missing values. If a brand has no snapshots, show "—" for all metrics.
6. Style with `glass rounded-2xl p-6` container, matching the existing `comparison-table.tsx` styling patterns (border-subtle rows, text-muted labels, text-primary values, tabular-nums for numbers).
7. Use `'use client'` directive.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors.
  </verify>
  <done>MetricsTable renders a side-by-side table of 8 key metrics for two brands, using the latest snapshot data, with proper formatting and dash placeholders for missing data.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- All three components exist in `src/components/comparison/`
- Each component is a named export with `'use client'` directive
- ButterflyChart uses Recharts BarChart with `layout="vertical"` and negative values
- CountryComparison merges countries from both brands and renders paired bars
- MetricsTable renders formatted metrics from latest snapshots
</verification>

<success_criteria>
Three standalone comparison components created that accept brand data props and render Recharts charts or HTML tables. All type-check cleanly. Ready for composition by the comparison page in Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/30-brand-comparison/30-01-SUMMARY.md`
</output>
