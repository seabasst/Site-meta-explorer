---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "Scraper uses rebrowser-puppeteer-core instead of puppeteer-core"
    - "Existing ad discovery functionality continues to work after upgrade"
    - "No detection/blocking observed during normal scraping operations"
  artifacts:
    - path: "package.json"
      provides: "npm alias for rebrowser-puppeteer-core"
      contains: "npm:rebrowser-puppeteer-core"
  key_links:
    - from: "src/lib/ad-library-scraper.ts"
      to: "puppeteer-core (aliased)"
      via: "import statement resolves to rebrowser package"
      pattern: "import puppeteer.*from 'puppeteer-core'"
---

<objective>
Upgrade scraping infrastructure from puppeteer-core to rebrowser-puppeteer-core using npm aliasing for anti-detection capabilities.

Purpose: Enable reliable, undetected scraping of Facebook Ad Library by fixing the Runtime.Enable CDP leak that triggers Cloudflare/DataDome detection.

Output: Updated package.json with npm alias, verified working scraper.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Key source file
@src/lib/ad-library-scraper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update package.json with npm aliasing</name>
  <files>package.json</files>
  <action>
Update package.json to use npm aliasing for rebrowser-puppeteer-core:

1. Change the puppeteer-core dependency from:
   ```json
   "puppeteer-core": "^24.35.0"
   ```
   To:
   ```json
   "puppeteer-core": "npm:rebrowser-puppeteer-core@^24.8.1"
   ```

2. Also update the puppeteer dependency (used for local dev) the same way:
   ```json
   "puppeteer": "npm:rebrowser-puppeteer@^24.8.1"
   ```

This uses npm's aliasing feature - all existing code importing from 'puppeteer-core' will automatically use rebrowser-puppeteer-core without any source code changes.

WHY version 24.8.1: This is the latest rebrowser version. While puppeteer is at 24.35.0, there are no breaking API changes in the 24.x series. The version lag is acceptable per research.
  </action>
  <verify>
Run `cat package.json | grep -A1 puppeteer` and confirm both dependencies show npm:rebrowser aliases.
  </verify>
  <done>package.json contains npm:rebrowser-puppeteer-core alias for puppeteer-core dependency</done>
</task>

<task type="auto">
  <name>Task 2: Install aliased packages and verify build</name>
  <files>package-lock.json</files>
  <action>
1. Delete node_modules and package-lock.json to ensure clean install:
   ```bash
   rm -rf node_modules package-lock.json
   ```

2. Run npm install to install the aliased packages:
   ```bash
   npm install
   ```

3. Verify the build succeeds:
   ```bash
   npm run build
   ```

The npm install will resolve puppeteer-core to rebrowser-puppeteer-core. TypeScript compilation should pass since rebrowser maintains the same API.

WHY clean install: npm aliasing can have caching issues with existing lock files. A clean install ensures the alias is properly resolved.
  </action>
  <verify>
1. `npm ls puppeteer-core` shows rebrowser-puppeteer-core@24.8.x
2. `npm run build` completes without errors
  </verify>
  <done>Aliased packages installed, TypeScript build passes, puppeteer-core resolves to rebrowser</done>
</task>

<task type="auto">
  <name>Task 3: Verify scraper functionality with test request</name>
  <files></files>
  <action>
Start the dev server and test the scraper endpoint to verify the upgrade works:

1. Start dev server:
   ```bash
   npm run dev &
   ```

2. Wait for server to be ready, then test the scrape-ads endpoint with a known Facebook Page ID. Use a small, public page to minimize scraping time:
   ```bash
   curl -X POST http://localhost:3000/api/scrape-ads \
     -H "Content-Type: application/json" \
     -d '{"url": "https://www.facebook.com/ads/library/?active_status=active&ad_type=all&country=ALL&view_all_page_id=108845530848"}' \
     --max-time 120
   ```

   (This is Meta's official page - should have ads and won't trigger blocking)

3. Verify the response:
   - Response should have `success: true`
   - Should include `ads` array (may be empty if Meta has no active ads)
   - Should NOT have detection/blocking errors

WHY this test: The scraper must work end-to-end with the new rebrowser package. Testing against a real Facebook page confirms the CDP patches are working.

NOTE: If the endpoint doesn't exist at /api/scrape-ads, check the actual route in src/app/api/ and use that path.
  </action>
  <verify>
1. Dev server starts successfully
2. API request returns JSON with `success: true` OR an error unrelated to detection (e.g., timeout is OK, blocked/captcha is NOT OK)
3. Stop the dev server after test
  </verify>
  <done>Scraper successfully makes request to Facebook Ad Library without detection errors</done>
</task>

</tasks>

<verification>
Phase 1 verification criteria (from ROADMAP.md):

1. Scraper uses rebrowser-puppeteer-core instead of puppeteer-core
   - Check: `npm ls puppeteer-core` shows rebrowser package

2. Existing ad discovery functionality continues to work after upgrade
   - Check: Test request to /api/scrape-ads returns success response

3. No detection/blocking observed during normal scraping operations
   - Check: Response does not contain CAPTCHA, blocked, or detection-related errors
</verification>

<success_criteria>
- package.json has `"puppeteer-core": "npm:rebrowser-puppeteer-core@^24.8.1"`
- `npm run build` passes
- Test scrape request returns `success: true` without detection errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
