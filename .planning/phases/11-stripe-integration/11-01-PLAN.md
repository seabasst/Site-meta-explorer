---
phase: 11-stripe-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - prisma/schema.prisma
  - src/lib/prisma.ts
  - src/lib/stripe.ts
  - .env.local.example
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing for Pro subscriptions"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: STRIPE_PRO_PRICE_ID
        source: "Stripe Dashboard -> Products -> Create product -> Copy price ID"
    dashboard_config:
      - task: "Create Pro subscription product"
        location: "Stripe Dashboard -> Products -> Add product"
        details: "Create recurring price (e.g., $9.99/month)"

must_haves:
  truths:
    - "Stripe SDK is available for server-side operations"
    - "Database can store user subscription state"
    - "Environment variables are documented for Stripe setup"
  artifacts:
    - path: "src/lib/stripe.ts"
      provides: "Stripe client singleton"
      exports: ["stripe"]
    - path: "src/lib/prisma.ts"
      provides: "Prisma client singleton"
      exports: ["prisma"]
    - path: "prisma/schema.prisma"
      provides: "User model with Stripe fields"
      contains: "model User"
  key_links:
    - from: "src/lib/stripe.ts"
      to: "process.env.STRIPE_SECRET_KEY"
      via: "Stripe constructor"
      pattern: "new Stripe.*STRIPE_SECRET_KEY"
    - from: "prisma/schema.prisma"
      to: "User model"
      via: "subscriptionStatus field"
      pattern: "subscriptionStatus.*String"
---

<objective>
Set up Stripe SDK and Prisma database foundation for subscription management.

Purpose: Provide the core infrastructure (Stripe client, database schema) that all subsequent subscription features depend on. This is the foundation wave that enables checkout, webhooks, and status display.

Output:
- Stripe client singleton at src/lib/stripe.ts
- Prisma client singleton at src/lib/prisma.ts
- User model with stripeCustomerId and subscriptionStatus fields
- Updated .env.local.example with Stripe variable documentation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-stripe-integration/11-RESEARCH.md

# Existing auth configuration (will NOT be modified - just for reference)
@src/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Prisma schema</name>
  <files>
    - package.json
    - prisma/schema.prisma
    - src/lib/prisma.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install stripe @stripe/stripe-js @prisma/client
   npm install prisma --save-dev
   npx prisma init --datasource-provider sqlite
   ```

2. Create User model in prisma/schema.prisma:
   ```prisma
   generator client {
     provider = "prisma-client-js"
   }

   datasource db {
     provider = "sqlite"
     url      = env("DATABASE_URL")
   }

   model User {
     id                 String   @id @default(cuid())
     email              String   @unique
     name               String?
     image              String?
     stripeCustomerId   String?  @unique
     subscriptionStatus String   @default("free") // free, pro, past_due, cancelled
     subscriptionId     String?
     createdAt          DateTime @default(now())
     updatedAt          DateTime @updatedAt
   }
   ```

3. Create Prisma client singleton at src/lib/prisma.ts:
   ```typescript
   import { PrismaClient } from '@prisma/client'

   const globalForPrisma = globalThis as unknown as {
     prisma: PrismaClient | undefined
   }

   export const prisma = globalForPrisma.prisma ?? new PrismaClient()

   if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
   ```

4. Generate Prisma client and create initial migration:
   ```bash
   npx prisma generate
   npx prisma db push
   ```

Note: Using db push instead of migrate for SQLite simplicity in development. The DATABASE_URL will be set to file:./dev.db by prisma init.
  </action>
  <verify>
    - `npx prisma validate` succeeds
    - `ls prisma/dev.db` confirms database file created
    - `npx prisma studio` opens successfully (Ctrl+C to close)
  </verify>
  <done>
    - Prisma schema has User model with stripeCustomerId, subscriptionStatus, subscriptionId fields
    - Prisma client singleton exists at src/lib/prisma.ts
    - SQLite database initialized at prisma/dev.db
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe client and update env template</name>
  <files>
    - src/lib/stripe.ts
    - .env.local.example
  </files>
  <action>
1. Create Stripe client singleton at src/lib/stripe.ts:
   ```typescript
   import Stripe from 'stripe';

   if (!process.env.STRIPE_SECRET_KEY) {
     throw new Error('STRIPE_SECRET_KEY is not set');
   }

   export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
     apiVersion: '2025-01-27.acacia', // Pin to current stable version
     typescript: true,
   });
   ```

   Note: Check the actual latest API version with `npm info stripe` or use the version from the installed package.

2. Update .env.local.example to add Stripe variables. READ THE FILE FIRST, then append:
   ```
   # Stripe Configuration (required for Pro subscriptions)
   # Get keys from: https://dashboard.stripe.com/apikeys
   STRIPE_SECRET_KEY=sk_test_...
   NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...

   # Create a product in Stripe Dashboard -> Products -> Add product
   # Use the Price ID (starts with price_)
   STRIPE_PRO_PRICE_ID=price_...

   # Webhook secret - get from `stripe listen` CLI (local) or Dashboard (production)
   STRIPE_WEBHOOK_SECRET=whsec_...

   # App URL for Stripe redirects
   NEXT_PUBLIC_APP_URL=http://localhost:3000

   # Database (auto-generated by prisma init)
   # DATABASE_URL="file:./dev.db"
   ```

3. Add prisma/dev.db to .gitignore if not already present. READ .gitignore first, then add if needed:
   ```
   # Prisma
   prisma/dev.db
   prisma/dev.db-journal
   ```
  </action>
  <verify>
    - `npm run build` succeeds (Stripe client compiles without errors)
    - `.env.local.example` contains all Stripe variables with clear documentation
    - `.gitignore` includes prisma/dev.db
  </verify>
  <done>
    - Stripe client singleton exists at src/lib/stripe.ts with pinned API version
    - .env.local.example documents all required Stripe environment variables
    - Database files are gitignored
  </done>
</task>

</tasks>

<verification>
Run after all tasks complete:

```bash
# Prisma setup valid
npx prisma validate

# Build succeeds (catches TypeScript errors)
npm run build

# Database exists
ls -la prisma/dev.db

# Check env template has Stripe vars
grep -c "STRIPE" .env.local.example
```

Expected: All commands succeed, grep returns 4+ matches for STRIPE vars.
</verification>

<success_criteria>
- Stripe SDK installed and Stripe client singleton at src/lib/stripe.ts
- Prisma installed with User model containing stripeCustomerId, subscriptionStatus, subscriptionId
- Prisma client singleton at src/lib/prisma.ts
- SQLite database initialized at prisma/dev.db
- .env.local.example documents all required Stripe variables
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-stripe-integration/11-01-SUMMARY.md`
</output>
