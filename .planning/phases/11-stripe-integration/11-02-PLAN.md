---
phase: 11-stripe-integration
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - src/app/actions/stripe.ts
  - src/components/subscription/upgrade-button.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Upgrade to Pro button"
    - "Clicking Upgrade redirects to Stripe Checkout"
    - "Only logged-in users can initiate checkout"
  artifacts:
    - path: "src/app/actions/stripe.ts"
      provides: "Server Action for checkout session creation"
      exports: ["createCheckoutSession"]
    - path: "src/components/subscription/upgrade-button.tsx"
      provides: "Upgrade button component with loading state"
      exports: ["UpgradeButton"]
  key_links:
    - from: "src/components/subscription/upgrade-button.tsx"
      to: "src/app/actions/stripe.ts"
      via: "form action calling createCheckoutSession"
      pattern: "action.*createCheckoutSession"
    - from: "src/app/actions/stripe.ts"
      to: "stripe.checkout.sessions.create"
      via: "Stripe SDK call"
      pattern: "stripe\\.checkout\\.sessions\\.create"
---

<objective>
Implement the Stripe Checkout flow so users can upgrade to Pro.

Purpose: Enable PAY-01 requirement - "User can subscribe to Pro tier via Stripe checkout". This creates the payment initiation flow using Server Actions with redirect pattern.

Output:
- Server Action createCheckoutSession at src/app/actions/stripe.ts
- UpgradeButton component at src/components/subscription/upgrade-button.tsx
- Upgrade CTA integrated into main page for logged-in users
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-stripe-integration/11-RESEARCH.md

# From Plan 01 (dependency)
@src/lib/stripe.ts
@src/lib/prisma.ts

# Existing auth (for getting user session)
@src/auth.ts
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create checkout Server Action</name>
  <files>
    - src/app/actions/stripe.ts
  </files>
  <action>
Create src/app/actions/stripe.ts with createCheckoutSession Server Action:

```typescript
'use server';

import { redirect } from 'next/navigation';
import { auth } from '@/auth';
import { stripe } from '@/lib/stripe';
import { prisma } from '@/lib/prisma';

export async function createCheckoutSession() {
  const session = await auth();

  if (!session?.user?.email) {
    throw new Error('Must be logged in to upgrade');
  }

  // Find or create user in database
  let user = await prisma.user.findUnique({
    where: { email: session.user.email },
  });

  if (!user) {
    user = await prisma.user.create({
      data: {
        email: session.user.email,
        name: session.user.name,
        image: session.user.image,
      },
    });
  }

  // If user already has a Stripe customer, use it
  let customerId = user.stripeCustomerId;

  if (!customerId) {
    // Create Stripe customer
    const customer = await stripe.customers.create({
      email: session.user.email,
      name: session.user.name || undefined,
      metadata: {
        userId: user.id,
      },
    });
    customerId = customer.id;

    // Store customer ID
    await prisma.user.update({
      where: { id: user.id },
      data: { stripeCustomerId: customerId },
    });
  }

  // Create checkout session
  const checkoutSession = await stripe.checkout.sessions.create({
    mode: 'subscription',
    payment_method_types: ['card'],
    customer: customerId,
    line_items: [
      {
        price: process.env.STRIPE_PRO_PRICE_ID!,
        quantity: 1,
      },
    ],
    success_url: `${process.env.NEXT_PUBLIC_APP_URL}/?upgrade=success`,
    cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/?upgrade=cancelled`,
    metadata: {
      userId: user.id,
    },
    allow_promotion_codes: true,
  });

  if (!checkoutSession.url) {
    throw new Error('Failed to create checkout session');
  }

  redirect(checkoutSession.url);
}
```

Key implementation notes:
- Uses Server Action with 'use server' directive
- Gets user session via auth() from Auth.js
- Creates user in DB if not exists (first-time checkout)
- Creates Stripe customer if not exists, stores customerId
- Passes userId in metadata for webhook to identify user
- Uses redirect() from next/navigation (not Response.redirect)
- allow_promotion_codes enables discount codes
  </action>
  <verify>
    - File exists at src/app/actions/stripe.ts
    - `npm run build` passes (no TypeScript errors)
  </verify>
  <done>
    - createCheckoutSession Server Action implemented
    - Creates/finds user in database
    - Creates/reuses Stripe customer
    - Redirects to Stripe Checkout
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UpgradeButton component and integrate into page</name>
  <files>
    - src/components/subscription/upgrade-button.tsx
    - src/app/page.tsx
  </files>
  <action>
1. Create src/components/subscription/upgrade-button.tsx:

```typescript
'use client';

import { useTransition } from 'react';
import { useSession } from 'next-auth/react';
import { createCheckoutSession } from '@/app/actions/stripe';

export function UpgradeButton() {
  const { data: session } = useSession();
  const [isPending, startTransition] = useTransition();

  if (!session) {
    return null; // Don't show upgrade button if not logged in
  }

  const handleUpgrade = () => {
    startTransition(async () => {
      await createCheckoutSession();
    });
  };

  return (
    <button
      onClick={handleUpgrade}
      disabled={isPending}
      className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
    >
      {isPending ? 'Redirecting...' : 'Upgrade to Pro'}
    </button>
  );
}
```

2. READ src/app/page.tsx first, then add UpgradeButton to the header area.

Look for where the auth UI (UserMenu, SignInButton) is rendered. Add the UpgradeButton nearby, shown only for logged-in users. Example integration pattern:

```tsx
import { UpgradeButton } from '@/components/subscription/upgrade-button';

// In the header section, near the auth UI:
<div className="flex items-center gap-4">
  <UpgradeButton />
  {/* existing auth UI */}
</div>
```

The exact placement depends on the current page.tsx structure. Place it in the header, before or after the user menu, visible to logged-in users.
  </action>
  <verify>
    - `npm run build` passes
    - `npm run dev` and visit http://localhost:3000
    - When logged in, "Upgrade to Pro" button is visible in header
    - When logged out, button is not visible
  </verify>
  <done>
    - UpgradeButton component shows for logged-in users
    - Clicking button shows "Redirecting..." state
    - Button integrated into page header
    - Full checkout flow works when Stripe is configured
  </done>
</task>

</tasks>

<verification>
Run after all tasks complete:

```bash
# Build passes
npm run build

# Manual testing (requires Stripe test keys configured):
# 1. npm run dev
# 2. Log in with demo@example.com / demo123
# 3. Click "Upgrade to Pro"
# 4. Should redirect to Stripe Checkout (or show error if keys not configured)
```

Note: Full flow requires STRIPE_SECRET_KEY, STRIPE_PRO_PRICE_ID configured in .env.local. Without them, clicking the button will throw an error (expected - documented in user_setup).
</verification>

<success_criteria>
- createCheckoutSession Server Action exists and compiles
- UpgradeButton component exists with loading state
- Button visible in header for logged-in users only
- Clicking button initiates checkout flow (redirects to Stripe when configured)
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-stripe-integration/11-02-SUMMARY.md`
</output>
