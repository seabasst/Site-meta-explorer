---
phase: 11-stripe-integration
plan: 04
type: execute
wave: 3
depends_on: [11-02, 11-03]
files_modified:
  - src/app/actions/stripe.ts
  - src/components/subscription/subscription-status.tsx
  - src/components/subscription/manage-subscription-button.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their current subscription status"
    - "User can access Customer Portal to cancel subscription"
    - "User can access Customer Portal to resume subscription"
    - "UI shows appropriate actions based on subscription state"
  artifacts:
    - path: "src/components/subscription/subscription-status.tsx"
      provides: "Component displaying current plan and status"
      exports: ["SubscriptionStatus"]
    - path: "src/components/subscription/manage-subscription-button.tsx"
      provides: "Button to open Stripe Customer Portal"
      exports: ["ManageSubscriptionButton"]
    - path: "src/app/actions/stripe.ts"
      provides: "createPortalSession Server Action"
      exports: ["createCheckoutSession", "createPortalSession"]
  key_links:
    - from: "src/components/subscription/manage-subscription-button.tsx"
      to: "src/app/actions/stripe.ts"
      via: "form action calling createPortalSession"
      pattern: "action.*createPortalSession"
    - from: "src/components/subscription/subscription-status.tsx"
      to: "src/lib/subscription.ts"
      via: "getSubscriptionStatus call"
      pattern: "getSubscriptionStatus"
---

<objective>
Implement subscription status display and management UI via Stripe Customer Portal.

Purpose: Enable PAY-02 requirement - "User can manage subscription (view status, cancel, resume)". Users see their current plan status and can access Stripe's Customer Portal for self-service management (cancel, resume, update payment method).

Output:
- SubscriptionStatus component showing current plan
- ManageSubscriptionButton component opening Customer Portal
- createPortalSession Server Action
- Integrated subscription UI in main page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-stripe-integration/11-RESEARCH.md

# From Plan 01
@src/lib/stripe.ts
@src/lib/prisma.ts

# From Plan 02
@src/app/actions/stripe.ts
@src/components/subscription/upgrade-button.tsx

# From Plan 03
@src/lib/subscription.ts

# Current page (to integrate subscription UI)
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add createPortalSession Server Action</name>
  <files>
    - src/app/actions/stripe.ts
  </files>
  <action>
READ src/app/actions/stripe.ts first (created in Plan 02), then ADD the createPortalSession function:

```typescript
// Add this function after createCheckoutSession

export async function createPortalSession() {
  const session = await auth();

  if (!session?.user?.email) {
    throw new Error('Must be logged in to manage subscription');
  }

  // Find user in database
  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: { stripeCustomerId: true },
  });

  if (!user?.stripeCustomerId) {
    throw new Error('No active subscription found');
  }

  // Create billing portal session
  const portalSession = await stripe.billingPortal.sessions.create({
    customer: user.stripeCustomerId,
    return_url: `${process.env.NEXT_PUBLIC_APP_URL}/`,
  });

  redirect(portalSession.url);
}
```

Key notes:
- Uses stored stripeCustomerId from database (no need to query Stripe)
- Customer Portal is pre-configured in Stripe Dashboard
- Portal handles cancel, resume, payment method update automatically
- Returns user to home page after portal actions
  </action>
  <verify>
    - src/app/actions/stripe.ts exports both createCheckoutSession and createPortalSession
    - `npm run build` passes
  </verify>
  <done>
    - createPortalSession Server Action added
    - Uses database stripeCustomerId
    - Redirects to Stripe Customer Portal
  </done>
</task>

<task type="auto">
  <name>Task 2: Create subscription management components</name>
  <files>
    - src/components/subscription/subscription-status.tsx
    - src/components/subscription/manage-subscription-button.tsx
  </files>
  <action>
1. Create src/components/subscription/manage-subscription-button.tsx:

```typescript
'use client';

import { useTransition } from 'react';
import { createPortalSession } from '@/app/actions/stripe';

export function ManageSubscriptionButton() {
  const [isPending, startTransition] = useTransition();

  const handleManage = () => {
    startTransition(async () => {
      await createPortalSession();
    });
  };

  return (
    <button
      onClick={handleManage}
      disabled={isPending}
      className="text-sm text-blue-600 hover:text-blue-800 hover:underline disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {isPending ? 'Opening...' : 'Manage subscription'}
    </button>
  );
}
```

2. Create src/components/subscription/subscription-status.tsx:

```typescript
import { auth } from '@/auth';
import { getSubscriptionStatus, type SubscriptionStatus as Status } from '@/lib/subscription';
import { UpgradeButton } from './upgrade-button';
import { ManageSubscriptionButton } from './manage-subscription-button';

export async function SubscriptionStatus() {
  const session = await auth();

  if (!session?.user?.email) {
    return null;
  }

  const status = await getSubscriptionStatus(session.user.email);

  return (
    <div className="flex items-center gap-3">
      <StatusBadge status={status} />
      <StatusAction status={status} />
    </div>
  );
}

function StatusBadge({ status }: { status: Status }) {
  switch (status) {
    case 'pro':
      return (
        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gradient-to-r from-blue-500 to-purple-500 text-white">
          Pro
        </span>
      );
    case 'past_due':
      return (
        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
          Payment Issue
        </span>
      );
    case 'cancelled':
      return (
        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
          Cancelled
        </span>
      );
    default:
      return (
        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
          Free
        </span>
      );
  }
}

function StatusAction({ status }: { status: Status }) {
  switch (status) {
    case 'pro':
    case 'past_due':
      return <ManageSubscriptionButton />;
    case 'cancelled':
      // User can resubscribe via upgrade button
      return <UpgradeButton />;
    default:
      // Free users see upgrade button (handled by UpgradeButton in header)
      return null;
  }
}
```

Key notes:
- SubscriptionStatus is a Server Component (async, fetches status)
- StatusBadge shows visual indicator of current plan
- StatusAction shows appropriate action based on state
- Pro/past_due users see "Manage subscription" (Customer Portal)
- Cancelled users see "Upgrade to Pro" (can resubscribe)
- Free users see nothing here (UpgradeButton already in header)
  </action>
  <verify>
    - Both files exist in src/components/subscription/
    - `npm run build` passes
  </verify>
  <done>
    - ManageSubscriptionButton component with Customer Portal redirect
    - SubscriptionStatus component with status badge and appropriate action
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate subscription status into page UI</name>
  <files>
    - src/app/page.tsx
  </files>
  <action>
READ src/app/page.tsx first, then integrate SubscriptionStatus into the header area.

Look for where UpgradeButton was added (Plan 02). The SubscriptionStatus should be shown for logged-in users, displaying their current plan status.

Strategy:
1. Import SubscriptionStatus component
2. Add it in the header section, near the user menu
3. Consider the layout - status badge should be visible but not dominate

Example integration (adjust based on actual page structure):

```tsx
import { SubscriptionStatus } from '@/components/subscription/subscription-status';

// In the header section:
<div className="flex items-center gap-4">
  <SubscriptionStatus />
  {/* existing auth UI (UserMenu, etc) */}
</div>
```

The SubscriptionStatus handles its own visibility (returns null if not logged in), so it can be placed unconditionally.

Also: Update the UpgradeButton display logic. Since SubscriptionStatus now shows context-aware actions:
- Keep UpgradeButton visible for Free users
- Hide it for Pro users (they see status badge + manage link instead)

You may need to conditionally render UpgradeButton based on subscription status, or let SubscriptionStatus handle all subscription-related UI and remove the standalone UpgradeButton from header.

RECOMMENDED: Let SubscriptionStatus handle all subscription UI:
- Free: Shows "Free" badge + nothing (UpgradeButton elsewhere)
- Pro: Shows "Pro" badge + "Manage subscription" link
- Past Due: Shows "Payment Issue" badge + "Manage subscription" link
- Cancelled: Shows "Cancelled" badge + "Upgrade to Pro" button

Keep a single UpgradeButton CTA somewhere prominent (e.g., below the form) for Free users.
  </action>
  <verify>
    - `npm run build` passes
    - `npm run dev` and check:
      1. Free user: sees "Free" badge, "Upgrade to Pro" button visible
      2. Pro user: sees "Pro" badge, "Manage subscription" link
      3. Not logged in: no subscription UI shown
  </verify>
  <done>
    - SubscriptionStatus integrated into page header
    - Appropriate UI shown based on subscription state
    - Pro users can access Customer Portal via "Manage subscription"
  </done>
</task>

</tasks>

<verification>
Run after all tasks complete:

```bash
# Build passes
npm run build

# Start dev server and test manually
npm run dev

# Test scenarios:
# 1. Not logged in: No subscription UI visible
# 2. Logged in (demo user, free): "Free" badge, "Upgrade to Pro" button
# 3. After upgrading via Stripe test checkout: "Pro" badge, "Manage subscription" link
# 4. Click "Manage subscription": Redirects to Stripe Customer Portal
```

Full testing requires:
- Stripe test mode keys configured
- STRIPE_PRO_PRICE_ID set to a test price
- Customer Portal configured in Stripe Dashboard
- Complete a test checkout to become Pro
</verification>

<success_criteria>
- createPortalSession Server Action added to src/app/actions/stripe.ts
- SubscriptionStatus component displays current plan status
- ManageSubscriptionButton opens Stripe Customer Portal
- UI shows appropriate state: Free (upgrade), Pro (manage), Past Due (manage), Cancelled (upgrade)
- `npm run build` passes

**Phase 11 Success Criteria Met:**
1. User can click "Upgrade to Pro" and complete Stripe checkout (Plan 02)
2. User can view their current subscription status (Plan 04 - SubscriptionStatus)
3. User can cancel their subscription (Plan 04 - Customer Portal)
4. User can resume a cancelled subscription (Plan 04 - Customer Portal / re-checkout)
</success_criteria>

<output>
After completion, create `.planning/phases/11-stripe-integration/11-04-SUMMARY.md`
</output>
