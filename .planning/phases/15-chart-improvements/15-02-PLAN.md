---
phase: 15-chart-improvements
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/page.tsx
  - src/components/demographics/country-chart.tsx
  - src/components/demographics/age-gender-chart.tsx
  - src/components/demographics/media-type-chart.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a country bar in CountryChart and the ad list filters to show only ads targeting that country"
    - "User can click a media type bar in MediaTypeChart and the ad list filters to show only that media type"
    - "User can click an age group row in AgeGenderChart and see it highlighted (visual feedback)"
    - "User sees an active filter chip/badge when a chart filter is active"
    - "User can clear the filter by clicking the X on the filter chip or clicking the same chart element again"
    - "Non-active chart segments appear dimmed (opacity) when a filter is active"
  artifacts:
    - path: "src/app/page.tsx"
      provides: "Chart filter state, filter logic, ActiveChartFilter component, filtered ad list"
      contains: "chartFilter|ActiveChartFilter|setChartFilter"
    - path: "src/components/demographics/country-chart.tsx"
      provides: "Clickable country bars with visual feedback"
      contains: "onSegmentClick|activeFilter|cursor-pointer"
    - path: "src/components/demographics/age-gender-chart.tsx"
      provides: "Clickable age group rows with visual feedback"
      contains: "onSegmentClick|activeFilter"
    - path: "src/components/demographics/media-type-chart.tsx"
      provides: "Clickable media type bars with visual feedback"
      contains: "onSegmentClick|activeFilter|onClick"
  key_links:
    - from: "src/app/page.tsx"
      to: "CountryChart"
      via: "onSegmentClick prop"
      pattern: "onSegmentClick.*setChartFilter"
    - from: "src/app/page.tsx"
      to: "MediaTypeChart"
      via: "onSegmentClick prop"
      pattern: "onSegmentClick.*setChartFilter"
    - from: "src/app/page.tsx"
      to: "filteredAds"
      via: "useMemo filtering apiResult.ads by chartFilter"
      pattern: "filteredAds.*useMemo"
---

<objective>
Add click-to-filter interactivity so users can click chart elements to filter the ad list.

Purpose: Satisfy CHRT-03 (click chart element to filter). When a user clicks a country in CountryChart or a media type in MediaTypeChart, the "All Ads" table filters to show only matching ads. AgeGenderChart gets click highlighting (visual only, since demographics are aggregated and don't map cleanly to individual ads). An active filter badge shows what's filtered and allows clearing.

Output: Interactive charts with click-to-filter for country and media type, visual highlighting for age/gender, and a clearable filter indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-chart-improvements/15-RESEARCH.md
@.planning/phases/15-chart-improvements/15-01-SUMMARY.md

Key files to read before implementing:
@src/app/page.tsx
@src/components/demographics/country-chart.tsx
@src/components/demographics/age-gender-chart.tsx
@src/components/demographics/media-type-chart.tsx
@src/lib/facebook-api.ts (for FacebookAdResult type -- check demographicDistribution and mediaType fields)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chart filter state and ActiveChartFilter component to page.tsx</name>
  <files>src/app/page.tsx</files>
  <action>
  1. Add a chart filter state type and state variable near the other filter states (activeStatus, regionFilter, etc.):
     ```typescript
     const [chartFilter, setChartFilter] = useState<{
       type: 'country' | 'mediaType' | 'ageGender';
       value: string;
       label: string;
     } | null>(null);
     ```

  2. Add a `filteredAds` useMemo that filters `apiResult.ads` based on `chartFilter`:
     ```typescript
     const filteredAds = useMemo(() => {
       if (!chartFilter || !apiResult) return apiResult?.ads ?? [];
       switch (chartFilter.type) {
         case 'country':
           return apiResult.ads.filter(ad =>
             ad.demographicDistribution?.some(d => d.region === chartFilter.value)
           );
         case 'mediaType':
           return apiResult.ads.filter(ad => ad.mediaType === chartFilter.value.toLowerCase());
         default:
           return apiResult.ads;
       }
     }, [chartFilter, apiResult]);
     ```
     Import `useMemo` (already imported via useState from react).

  3. Create an inline `ActiveChartFilter` component (or define it above the Home component) that shows the active filter as a dismissable chip:
     - Styled as a rounded-full pill with green accent border
     - Shows "Filtered by: {label}"
     - Has an X button to clear (calls `setChartFilter(null)`)
     - Only renders when `chartFilter` is not null

  4. Render `ActiveChartFilter` just above the charts section (inside the "AUDIENCE OVERVIEW TAB CONTENT" section, after the "Audience Demographics" header and before the charts). Also render it in the "AD OVERVIEW TAB CONTENT" section before the ad table.

  5. Clear chartFilter when a new analysis is started (in handleAdLibrarySubmit, add `setChartFilter(null)` alongside the other state resets).

  6. Pass `onSegmentClick` and `activeFilter` props to chart components:
     - CountryChart: `onSegmentClick={(filter) => setChartFilter(prev => prev?.value === filter.value ? null : filter)}` and `activeFilter={chartFilter}`
     - AgeGenderChart: `onSegmentClick={(filter) => setChartFilter(prev => prev?.value === filter.value ? null : filter)}` and `activeFilter={chartFilter}`
     - MediaTypeChart: `onSegmentClick={(filter) => setChartFilter(prev => prev?.value === filter.value ? null : filter)}` and `activeFilter={chartFilter}`

  7. In the "All Active Ads" expandable table at the bottom of the ads tab, use `filteredAds` instead of `apiResult.ads` for the table body rows. Keep the header count showing total: "View all {apiResult.totalAdsFound} ads" but add a note when filtered: "(showing {filteredAds.length})".

  IMPORTANT: The toggle behavior -- clicking same element again clears the filter (prev?.value === filter.value ? null : filter).
  </action>
  <verify>
  Run `npx next build` to confirm no TypeScript errors. The page should still render correctly even though chart components don't yet accept the new props (TypeScript will warn but page.tsx changes should be structurally correct).
  </verify>
  <done>page.tsx has chartFilter state, filteredAds memo, ActiveChartFilter component, and passes onSegmentClick/activeFilter props to chart components. Filter clears on new analysis.</done>
</task>

<task type="auto">
  <name>Task 2: Add click-to-filter to CountryChart, AgeGenderChart, and MediaTypeChart</name>
  <files>
    src/components/demographics/country-chart.tsx
    src/components/demographics/age-gender-chart.tsx
    src/components/demographics/media-type-chart.tsx
  </files>
  <action>
  **CountryChart (country-chart.tsx):**
  1. Update `CountryChartProps` interface to accept optional props:
     ```typescript
     onSegmentClick?: (filter: { type: 'country'; value: string; label: string }) => void;
     activeFilter?: { type: string; value: string; label: string } | null;
     ```
  2. Add `cursor-pointer` class to each country row div.
  3. Add `onClick` handler to each country row that calls:
     ```typescript
     onSegmentClick?.({ type: 'country', value: country.originalName, label: `${country.flag} ${country.name}` })
     ```
  4. Add opacity dimming: When `activeFilter` is set and `activeFilter.type === 'country'`, non-matching country rows get `opacity-40`. The matching row stays full opacity. Use a transition for smooth visual feedback:
     ```typescript
     className={`group relative cursor-pointer transition-opacity duration-200 ${
       activeFilter?.type === 'country' && activeFilter.value !== country.originalName ? 'opacity-40' : ''
     }`}
     ```
  5. Do NOT dim rows when activeFilter.type is not 'country' (only dim within same chart type).

  **AgeGenderChart (age-gender-chart.tsx):**
  1. Update `AgeGenderChartProps` to accept:
     ```typescript
     onSegmentClick?: (filter: { type: 'ageGender'; value: string; label: string }) => void;
     activeFilter?: { type: string; value: string; label: string } | null;
     ```
  2. Add `cursor-pointer` to each age group row.
  3. Add `onClick` that calls: `onSegmentClick?.({ type: 'ageGender', value: group.age, label: `Age ${group.age}` })`
  4. Add opacity dimming for non-matching age groups when activeFilter.type === 'ageGender'.
  5. This is visual-only highlighting -- the page.tsx filteredAds logic returns all ads for ageGender type since demographics don't map to individual ads.

  **MediaTypeChart (media-type-chart.tsx):**
  1. Update `MediaTypeChartProps` to accept:
     ```typescript
     onSegmentClick?: (filter: { type: 'mediaType'; value: string; label: string }) => void;
     activeFilter?: { type: string; value: string; label: string } | null;
     ```
  2. Add `onClick` handler to the Recharts `<Bar>` component:
     ```typescript
     <Bar
       dataKey="percentage"
       radius={[0, 4, 4, 0]}
       onClick={(data) => {
         onSegmentClick?.({ type: 'mediaType', value: data.payload.name, label: data.payload.name });
       }}
       cursor="pointer"
     >
     ```
  3. Add visual feedback via Cell opacity: When activeFilter is set and type is 'mediaType', non-matching cells get reduced opacity:
     ```typescript
     <Cell
       key={`cell-${index}`}
       fill={entry.color}
       opacity={activeFilter?.type === 'mediaType' && activeFilter.value !== entry.name ? 0.3 : 1}
     />
     ```
  4. Also add cursor pointer to the summary stat cards at the top. Make them clickable with the same filter behavior -- clicking "Video Ads" card filters to video, clicking "Image Ads" card filters to image. Add a subtle ring/border highlight to the active card.
  </action>
  <verify>
  Run `npx next build` to confirm no TypeScript errors. Run `npm run dev` and test:
  1. Click a country in CountryChart -- non-clicked countries dim, ad table filters
  2. Click same country again -- filter clears, all countries return to full opacity
  3. Click a media type bar or stat card -- non-clicked types dim, ad table filters
  4. Click an age group row -- visual highlighting only, other groups dim
  5. Active filter chip appears and X button clears it
  </verify>
  <done>All three chart components accept onSegmentClick and activeFilter props. Clicking chart elements filters the ad list (country, mediaType) or highlights visually (ageGender). Non-active elements dim with opacity transition. Click same element again to clear filter.</done>
</task>

</tasks>

<verification>
1. `npx next build` completes without errors
2. Click country bar -> ad table filters to ads targeting that country, filter chip appears
3. Click media type bar or stat card -> ad table filters to that media type, filter chip appears
4. Click age group row -> visual highlighting, other groups dim (no ad filtering since demographics are aggregated)
5. Click active element again -> filter clears, all elements return to full opacity
6. Click X on filter chip -> filter clears
7. Start new analysis -> filter auto-clears
8. Charts still show correct hover tooltips (from Plan 01)
</verification>

<success_criteria>
- Country click filters ad list by region, showing only ads with demographic data in that region
- Media type click filters ad list by video/image
- Age/gender click provides visual highlighting without ad filtering
- Active filter shown as clearable chip badge
- Toggle behavior: clicking same element clears filter
- Filter auto-clears on new analysis
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-chart-improvements/15-02-SUMMARY.md`
</output>
