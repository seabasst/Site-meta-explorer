---
phase: 05-error-handling-foundation
plan: 04
type: execute
wave: 3
depends_on: [05-02, 05-03]
files_modified:
  - src/app/page.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User sees skeleton loading states while API fetches data"
    - "User sees clear, non-technical error messages when API fails"
    - "User can click Retry button to re-attempt failed API requests"
    - "User gets real-time validation feedback when URL is invalid"
  artifacts:
    - path: "src/app/page.tsx"
      provides: "Main page with integrated error handling, skeletons, and validation"
      min_lines: 900
  key_links:
    - from: "src/app/page.tsx"
      to: "src/components/loading/results-skeleton.tsx"
      via: "ResultsSkeleton import"
      pattern: "from.*loading/results-skeleton"
    - from: "src/app/page.tsx"
      to: "src/components/error/api-error-alert.tsx"
      via: "ApiErrorAlert import"
      pattern: "from.*error/api-error-alert"
    - from: "src/app/page.tsx"
      to: "src/lib/validation.ts"
      via: "validateAdLibraryUrl import"
      pattern: "from.*lib/validation"
    - from: "src/app/page.tsx"
      to: "sonner"
      via: "toast import for error notifications"
      pattern: "import.*toast.*from.*sonner"
---

<objective>
Integrate all error handling components into the main page: replace loading spinner with skeleton loading states, replace raw error display with ApiErrorAlert and toasts, add retry functionality, and implement real-time URL validation with inline feedback.

Purpose: This is the integration plan that wires all Phase 5 components together. Completes all four requirements: UIUX-01 (skeletons), ERRH-01 (friendly errors), ERRH-02 (retry), ERRH-03 (validation).

Output: Updated src/app/page.tsx with full error handling integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-error-handling-foundation/05-RESEARCH.md
@.planning/phases/05-error-handling-foundation/05-01-SUMMARY.md
@.planning/phases/05-error-handling-foundation/05-02-SUMMARY.md
@.planning/phases/05-error-handling-foundation/05-03-SUMMARY.md
@src/app/page.tsx
@src/lib/validation.ts
@src/lib/errors.ts
@src/components/error/api-error-alert.tsx
@src/components/loading/results-skeleton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add imports and state for validation/error handling</name>
  <files>
    - src/app/page.tsx
  </files>
  <action>
    Add new imports at top of page.tsx:

    ```typescript
    import { toast } from 'sonner';
    import { ResultsSkeleton } from '@/components/loading/results-skeleton';
    import { ApiErrorAlert } from '@/components/error/api-error-alert';
    import { validateAdLibraryUrl } from '@/lib/validation';
    import { getUserFriendlyMessage } from '@/lib/errors';
    ```

    Add new state for URL validation:

    ```typescript
    // Add after existing state declarations
    const [urlError, setUrlError] = useState<string | null>(null);
    ```

    Update the adError state type if needed to store Error objects:

    ```typescript
    const [adError, setAdError] = useState<Error | null>(null);
    ```
  </action>
  <verify>
    - Imports are added at top of file
    - urlError state exists
    - No TypeScript errors
  </verify>
  <done>
    - All required imports added
    - urlError state for inline validation
    - adError can store Error objects
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement real-time URL validation</name>
  <files>
    - src/app/page.tsx
  </files>
  <action>
    Add URL validation on blur (when user leaves input field):

    1. Add handleUrlBlur function:

    ```typescript
    const handleUrlBlur = () => {
      if (!adLibraryUrl.trim()) {
        setUrlError(null); // Don't show error for empty field
        return;
      }

      const result = validateAdLibraryUrl(adLibraryUrl.trim());
      setUrlError(result.valid ? null : result.error || null);
    };
    ```

    2. Clear validation error when user starts typing:

    ```typescript
    // Update the onChange handler for the URL input
    onChange={(e) => {
      setAdLibraryUrl(e.target.value);
      if (urlError) setUrlError(null); // Clear error when typing
    }}
    ```

    3. Add onBlur to the input field:

    ```typescript
    <input
      type="text"
      value={adLibraryUrl}
      onChange={(e) => {
        setAdLibraryUrl(e.target.value);
        if (urlError) setUrlError(null);
      }}
      onBlur={handleUrlBlur}
      placeholder="https://www.facebook.com/ads/library/?...&view_all_page_id=..."
      className={`input-field flex-1 ${urlError ? 'border-red-500 focus:ring-red-500' : ''}`}
      disabled={isLoadingAds}
      aria-invalid={!!urlError}
      aria-describedby={urlError ? 'url-error' : undefined}
    />
    ```

    4. Add inline error message below input (inside the form):

    ```typescript
    {urlError && (
      <p id="url-error" className="mt-2 text-sm text-red-500" role="alert">
        {urlError}
      </p>
    )}
    ```

    5. Prevent form submission if URL is invalid:

    ```typescript
    const handleAdLibrarySubmit = async (e: React.FormEvent) => {
      e.preventDefault();
      if (!adLibraryUrl.trim()) return;

      // Validate before submitting
      const validation = validateAdLibraryUrl(adLibraryUrl.trim());
      if (!validation.valid) {
        setUrlError(validation.error || 'Invalid URL');
        return;
      }

      setIsLoadingAds(true);
      // ... rest of submit logic
    };
    ```
  </action>
  <verify>
    - handleUrlBlur function exists
    - Input has onBlur handler
    - Error message displays below input when invalid
    - Form prevents submission of invalid URLs
  </verify>
  <done>
    - URL validated on blur (not on every keystroke)
    - Clear error message displayed inline
    - Submit blocked for invalid URLs
    - Input shows red border when invalid
    - Accessible (aria-invalid, aria-describedby)
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace loading spinner with skeleton and integrate error handling</name>
  <files>
    - src/app/page.tsx
  </files>
  <action>
    1. Replace the loading spinner section with ResultsSkeleton:

    Find this code (around line 633-644):
    ```tsx
    {/* Ad Library Loading */}
    {isLoadingAds && (
      <div className="mt-4 text-center py-8">
        <div className="inline-flex flex-col items-center gap-3">
          <LoadingSpinner size="lg" />
          ...
        </div>
      </div>
    )}
    ```

    Replace with:
    ```tsx
    {/* Ad Library Loading - Skeleton UI */}
    {isLoadingAds && !apiResult && (
      <ResultsSkeleton />
    )}
    ```

    2. Replace the error display with ApiErrorAlert and add retry:

    Find this code (around line 646-651):
    ```tsx
    {/* Ad Library Error */}
    {adError && (
      <div className="mt-4 p-3 rounded-lg bg-red-50 border border-red-200">
        <p className="text-red-600 text-sm">{adError}</p>
      </div>
    )}
    ```

    Replace with:
    ```tsx
    {/* Ad Library Error with Retry */}
    {adError && !isLoadingAds && (
      <ApiErrorAlert
        error={adError}
        onRetry={handleRetry}
        className="mt-4"
      />
    )}
    ```

    3. Add handleRetry function:

    ```typescript
    const handleRetry = () => {
      // Clear error and re-submit
      setAdError(null);
      handleAdLibrarySubmit({ preventDefault: () => {} } as React.FormEvent);
    };
    ```

    4. Update error handling in handleAdLibrarySubmit to use toast and store Error:

    ```typescript
    } catch (error) {
      const errorObj = error instanceof Error ? error : new Error('Failed to fetch Ad Library data');
      setAdError(errorObj);

      // Also show toast notification
      toast.error('Failed to analyze ads', {
        description: getUserFriendlyMessage(errorObj),
        action: {
          label: 'Retry',
          onClick: handleRetry,
        },
      });
    } finally {
      setIsLoadingAds(false);
    }
    ```

    Also update the API error response handling:
    ```typescript
    if (response.success) {
      setApiResult(response);
      setAdError(null);
    } else {
      const errorObj = new Error(response.error || 'Failed to fetch Ad Library data');
      setAdError(errorObj);
      toast.error('Failed to analyze ads', {
        description: getUserFriendlyMessage(errorObj),
        action: {
          label: 'Retry',
          onClick: handleRetry,
        },
      });
    }
    ```
  </action>
  <verify>
    - ResultsSkeleton used during loading
    - ApiErrorAlert used for error display
    - handleRetry function exists
    - Toast shown on API error
    - Both inline error and toast have retry action
  </verify>
  <done>
    - Skeleton loading replaces spinner (UIUX-01)
    - ApiErrorAlert shows user-friendly error (ERRH-01)
    - Retry button in error alert (ERRH-02)
    - Toast notification with retry action (ERRH-02)
    - Error state properly managed
  </done>
</task>

</tasks>

<verification>
1. Build check: `npm run build` succeeds
2. Manual testing (dev server):
   - Enter invalid URL, blur out -> shows inline error
   - Enter valid URL, submit -> shows skeleton loading
   - API fails -> shows error alert with retry button AND toast
   - Click retry -> re-submits request
   - Successful response -> shows results
</verification>

<success_criteria>
- [UIUX-01] User sees skeleton loading states while data fetches
- [ERRH-01] User sees clear, non-technical error messages when API fails
- [ERRH-02] User can click "Retry" button to re-attempt failed requests
- [ERRH-03] User gets real-time validation feedback on URL input (on blur)
- All Phase 5 requirements complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-error-handling-foundation/05-04-SUMMARY.md`
</output>
