---
phase: 12-tier-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tiers.ts
  - src/hooks/use-tier-access.ts
  - src/app/api/subscription/status/route.ts
autonomous: true

must_haves:
  truths:
    - "Tier configuration is centralized in one file"
    - "Client components can check user's tier via hook"
    - "API returns tier info alongside subscription status"
  artifacts:
    - path: "src/lib/tiers.ts"
      provides: "Tier configuration constants and helpers"
      exports: ["TierName", "TierConfig", "TIERS", "getTierFromStatus", "isDepthAllowed", "getMaxDepth"]
    - path: "src/hooks/use-tier-access.ts"
      provides: "Client-side tier access hook"
      exports: ["useTierAccess"]
    - path: "src/app/api/subscription/status/route.ts"
      provides: "Enhanced subscription status API"
      contains: "tier"
  key_links:
    - from: "src/hooks/use-tier-access.ts"
      to: "src/lib/tiers.ts"
      via: "imports tier config"
      pattern: "import.*from.*tiers"
    - from: "src/hooks/use-tier-access.ts"
      to: "/api/subscription/status"
      via: "fetch call"
      pattern: "fetch.*api/subscription/status"
    - from: "src/app/api/subscription/status/route.ts"
      to: "src/lib/tiers.ts"
      via: "imports tier helpers"
      pattern: "import.*from.*tiers"
---

<objective>
Create tier configuration foundation and client-side tier access hook.

Purpose: Establish centralized tier logic that both server and client can use for consistent enforcement.
Output: Tier config file, useTierAccess hook, enhanced subscription status API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-tier-enforcement/12-RESEARCH.md
@src/lib/subscription.ts
@src/app/api/subscription/status/route.ts
@src/hooks/use-favorites.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tier configuration file</name>
  <files>src/lib/tiers.ts</files>
  <action>
Create tier configuration with centralized constants and helpers:

```typescript
// src/lib/tiers.ts
export type TierName = 'free' | 'pro';

export interface TierConfig {
  name: TierName;
  label: string;
  maxAds: number;
  availableDepths: readonly number[];
  features: {
    deepAnalysis: boolean;
    export: boolean;
    adPreviews: boolean;
  };
}

export const TIERS: Record<TierName, TierConfig> = {
  free: {
    name: 'free',
    label: 'Free',
    maxAds: 100,
    availableDepths: [100] as const,
    features: {
      deepAnalysis: false,
      export: false,
      adPreviews: false,
    },
  },
  pro: {
    name: 'pro',
    label: 'Pro',
    maxAds: 1000,
    availableDepths: [100, 500, 1000] as const,
    features: {
      deepAnalysis: true,
      export: true,
      adPreviews: true,
    },
  },
} as const;

// Helper to get tier from subscription status
export function getTierFromStatus(
  status: 'free' | 'pro' | 'past_due' | 'cancelled' | 'unauthenticated'
): TierName {
  // Pro access for active subscriptions only
  // past_due gets grace period (treat as pro for now)
  return status === 'pro' || status === 'past_due' ? 'pro' : 'free';
}

// Validate requested depth against tier
export function isDepthAllowed(tier: TierName, depth: number): boolean {
  return TIERS[tier].availableDepths.includes(depth);
}

// Get max allowed depth for tier
export function getMaxDepth(tier: TierName): number {
  return TIERS[tier].maxAds;
}
```

Key design decisions:
- past_due users get grace period (still treated as pro)
- Simple 2-tier model: free (100 ads) vs pro (100/500/1000 ads)
- Features object for future Phase 13 gating (export, previews)
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors in tiers.ts</verify>
  <done>Tier config file exists with TierName, TierConfig, TIERS, and helper functions exported</done>
</task>

<task type="auto">
  <name>Task 2: Create useTierAccess hook</name>
  <files>src/hooks/use-tier-access.ts</files>
  <action>
Create client-side hook for tier checking:

```typescript
// src/hooks/use-tier-access.ts
'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';
import { getTierFromStatus, TIERS, type TierConfig, type TierName } from '@/lib/tiers';
import type { SubscriptionStatus } from '@/lib/subscription';

interface TierAccess {
  tier: TierName;
  config: TierConfig;
  isPro: boolean;
  isLoading: boolean;
  canUseDepth: (depth: number) => boolean;
}

export function useTierAccess(): TierAccess {
  const { data: session, status: authStatus } = useSession();
  const [subscriptionStatus, setSubscriptionStatus] = useState<SubscriptionStatus | 'unauthenticated'>('free');
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    if (authStatus === 'loading') return;

    // Unauthenticated users get free tier
    if (!session?.user?.email) {
      setSubscriptionStatus('unauthenticated');
      setIsLoading(false);
      return;
    }

    // Fetch subscription status
    fetch('/api/subscription/status')
      .then((res) => res.json())
      .then((data) => {
        setSubscriptionStatus(data.status || 'free');
        setIsLoading(false);
      })
      .catch(() => {
        setSubscriptionStatus('free');
        setIsLoading(false);
      });
  }, [session?.user?.email, authStatus]);

  const tier = getTierFromStatus(subscriptionStatus);
  const config = TIERS[tier];

  return {
    tier,
    config,
    isPro: tier === 'pro',
    isLoading: authStatus === 'loading' || isLoading,
    canUseDepth: (depth: number) => config.availableDepths.includes(depth),
  };
}
```

Follow existing hook pattern from use-favorites.ts:
- 'use client' directive at top
- useEffect for side effects
- Loading state handling
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors in use-tier-access.ts</verify>
  <done>useTierAccess hook exists and exports TierAccess interface with tier, config, isPro, isLoading, canUseDepth</done>
</task>

<task type="auto">
  <name>Task 3: Enhance subscription status API</name>
  <files>src/app/api/subscription/status/route.ts</files>
  <action>
Extend the existing /api/subscription/status to return tier info alongside status:

```typescript
// src/app/api/subscription/status/route.ts
import { NextResponse } from 'next/server';
import { auth } from '@/auth';
import { getSubscriptionStatus } from '@/lib/subscription';
import { getTierFromStatus, TIERS } from '@/lib/tiers';

export async function GET() {
  const session = await auth();

  if (!session?.user?.email) {
    // Unauthenticated users get free tier info
    return NextResponse.json({
      status: 'unauthenticated',
      tier: 'free',
      maxAds: TIERS.free.maxAds,
      availableDepths: TIERS.free.availableDepths,
    });
  }

  const status = await getSubscriptionStatus(session.user.email);
  const tier = getTierFromStatus(status);
  const config = TIERS[tier];

  return NextResponse.json({
    status,
    tier,
    maxAds: config.maxAds,
    availableDepths: config.availableDepths,
  });
}
```

Key changes:
- Import tier helpers
- Return tier name and limits
- Unauthenticated users get free tier info (not 401)
- Consistent with useTierAccess hook expectations
  </action>
  <verify>
Run `curl http://localhost:3000/api/subscription/status` (while logged out) - should return:
```json
{"status":"unauthenticated","tier":"free","maxAds":100,"availableDepths":[100]}
```
  </verify>
  <done>API returns status, tier, maxAds, and availableDepths for both authenticated and unauthenticated users</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] /api/subscription/status returns tier info
</verification>

<success_criteria>
- Tier configuration centralized in src/lib/tiers.ts
- useTierAccess hook provides tier info to client components
- API endpoint returns tier alongside subscription status
- All helpers (getTierFromStatus, isDepthAllowed, getMaxDepth) work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/12-tier-enforcement/12-01-SUMMARY.md`
</output>
