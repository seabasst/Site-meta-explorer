---
phase: 26-re-analysis-and-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/dashboard/own-brand-card.tsx
  - src/components/dashboard/competitor-card.tsx
  - src/app/dashboard/[brandId]/page.tsx
  - src/app/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can trigger fresh analysis from brand detail page"
    - "Fresh analysis creates a new snapshot and updates displayed data"
    - "Brand detail page shows list of historical snapshots"
    - "Own brand card shows last analyzed timestamp"
    - "Competitor card continues to show last analyzed date"
  artifacts:
    - path: "src/app/dashboard/[brandId]/page.tsx"
      provides: "Re-analyze button and snapshot history timeline"
      contains: "Re-analyze"
    - path: "src/components/dashboard/own-brand-card.tsx"
      provides: "Last analyzed timestamp on own brand card"
      contains: "snapshotDate"
  key_links:
    - from: "src/app/dashboard/[brandId]/page.tsx"
      to: "/api/dashboard/snapshots"
      via: "fetch POST to trigger re-analysis"
      pattern: "fetch.*api/dashboard/snapshots"
    - from: "src/app/dashboard/[brandId]/page.tsx"
      to: "/api/dashboard/snapshots"
      via: "fetch GET to load snapshot history"
      pattern: "fetch.*api/dashboard/snapshots.*GET"
---

<objective>
Add re-analysis capabilities and snapshot history to the brand tracking dashboard.

Purpose: Users need to refresh brand analysis data over time and see how metrics change. The backend already supports multiple snapshots per brand and has a working re-analysis API endpoint. This plan surfaces those capabilities in the UI by adding a re-analyze button on the brand detail page, a snapshot history timeline, and ensuring "last analyzed" timestamps are visible everywhere.

Output: Updated brand detail page with re-analyze button and history section; own brand card with last analyzed timestamp.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-dashboard/25-01-SUMMARY.md

Key existing infrastructure (no changes needed):
- POST /api/dashboard/snapshots — already calls Facebook API and creates a new BrandSnapshot
- GET /api/dashboard/snapshots?trackedBrandId=X — already returns historical snapshots ordered by date desc
- BrandSnapshot model already supports multiple snapshots per TrackedBrand
- handleSnapshot in dashboard/page.tsx already wires the Refresh button to the snapshots API
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add last analyzed timestamp to own brand card and ensure competitor cards show it</name>
  <files>
    src/components/dashboard/own-brand-card.tsx
  </files>
  <action>
  In OwnBrandCard, add a "last analyzed" timestamp below the metrics grid when a snapshot exists. Show it as: "Last analyzed: Jan 28, 2026 at 3:45 PM" using the snapshot's snapshotDate field. Use the same muted text style as the competitor card date (text-[10px] or text-xs, text-[var(--text-muted)]).

  Place it after the metrics grid div, before the closing of the snapshot conditional block. Format with toLocaleDateString and toLocaleTimeString for readability.

  The competitor card already shows the snapshot date at the bottom of each card (added in Phase 25), so REANA-04 is already satisfied there. No changes needed to competitor-card.tsx.
  </action>
  <verify>
  Run `npx tsc --noEmit` — zero errors. Visually confirm the own brand card shows "Last analyzed: [date]" when a snapshot exists.
  </verify>
  <done>Own brand card displays "last analyzed" timestamp from latest snapshot. Competitor cards already show this from Phase 25.</done>
</task>

<task type="auto">
  <name>Task 2: Add re-analyze button and snapshot history to brand detail page</name>
  <files>
    src/app/dashboard/[brandId]/page.tsx
  </files>
  <action>
  Update the brand detail page with two new features:

  1. RE-ANALYZE BUTTON: Add a "Re-analyze" button next to the "View in Ad Library" link in the brand header section. When clicked:
     - Call POST /api/dashboard/snapshots with { trackedBrandId: brand.id }
     - Show loading state on the button ("Analyzing..." with disabled state)
     - On success, call refresh() from useTrackedBrands to update the displayed snapshot, AND re-fetch the history list
     - On error, show a toast error using sonner (import { toast } from 'sonner')
     - Style: btn-primary or accent-green background, small size (text-xs px-3 py-1.5), matching the dashboard card button style

  2. SNAPSHOT HISTORY SECTION: Add a "History" section at the bottom of the page (after demographics). This section:
     - Fetches historical snapshots from GET /api/dashboard/snapshots?trackedBrandId={brandId} using a useEffect
     - Shows a simple timeline/list of past snapshots, ordered newest first
     - Each entry shows: date (formatted nicely), key metrics (active ads, total reach, est. spend)
     - Use the glass rounded-2xl p-6 card style for the section container
     - Each history entry is a compact row: date on the left, 3 key metrics on the right
     - Limit display to last 10 snapshots
     - If only 1 snapshot exists, show "No previous snapshots yet. Re-analyze to start tracking changes."
     - Highlight the current (latest) snapshot with a subtle accent indicator (e.g., small green dot or "Latest" badge)

  3. LAST ANALYZED TIMESTAMP: Add "Last analyzed: [date]" below the brand name in the header, using text-xs text-[var(--text-muted)]. Use the latest snapshot's snapshotDate.

  Implementation details:
  - Add state: const [analyzing, setAnalyzing] = useState(false)
  - Add state: const [history, setHistory] = useState<TrackedBrandSnapshot[]>([])
  - Add a fetchHistory function that calls GET /api/dashboard/snapshots?trackedBrandId={brandId}&limit=10
  - Call fetchHistory in a useEffect when brandId is available
  - The re-analyze handler should: setAnalyzing(true), POST to snapshots, refresh(), fetchHistory(), setAnalyzing(false)
  - Import toast from 'sonner' for error handling
  - Reuse the TrackedBrandSnapshot type from use-tracked-brands hook
  - Reuse the existing formatReach helper already in the file
  </action>
  <verify>
  Run `npx tsc --noEmit` — zero errors. Run `npm run build` — successful build. Verify the brand detail page renders without errors by checking the build output includes the /dashboard/[brandId] route.
  </verify>
  <done>
  Brand detail page has: (1) Re-analyze button that triggers fresh Facebook API analysis and updates displayed data, (2) Last analyzed timestamp in header, (3) Snapshot history section showing past analyses with key metrics.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero type errors
2. `npm run build` completes successfully
3. All four requirements covered:
   - REANA-01: Re-analyze button on brand detail page triggers POST /api/dashboard/snapshots
   - REANA-02: After re-analysis, refresh() updates the displayed snapshot to show fresh data
   - REANA-03: History section fetches and displays multiple past snapshots per brand
   - REANA-04: "Last analyzed" timestamp on own brand card and brand detail page header
</verification>

<success_criteria>
- Own brand card shows "Last analyzed: [date]" when snapshot exists
- Brand detail page has a working "Re-analyze" button with loading state
- Brand detail page shows snapshot history timeline with dates and key metrics
- Brand detail page header shows "Last analyzed" timestamp
- All existing functionality (Refresh buttons on dashboard cards) continues to work
- TypeScript compiles without errors
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/26-re-analysis-and-history/26-01-SUMMARY.md`
</output>
