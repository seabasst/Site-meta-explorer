---
phase: 16-export-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/lib/pdf-export.ts
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "PDF includes content from ALL three tabs (audience, ads, expert) regardless of which tab is active"
    - "User sees a progress indicator while PDF is being generated"
    - "Collapsed details sections are fully captured in the PDF"
    - "Export button shows meaningful progress (not just a spinner)"
  artifacts:
    - path: "src/lib/pdf-export.ts"
      provides: "Multi-tab capture with DOM preparation and progress callback"
      exports: ["exportToPDF"]
    - path: "src/app/page.tsx"
      provides: "Progress UI during PDF export"
      contains: "pdfProgress"
  key_links:
    - from: "src/lib/pdf-export.ts"
      to: "src/app/page.tsx"
      via: "onProgress callback updates UI state"
      pattern: "onProgress"
    - from: "src/lib/pdf-export.ts"
      to: "src/app/page.tsx"
      via: "Temporarily shows all tab content for capture"
      pattern: "resultsTab|data-pdf-tab"
---

<objective>
Add multi-tab content capture and export progress feedback so the PDF includes all analysis sections regardless of which tab the user is viewing.

Purpose: Currently only the active tab's content is in the DOM and gets captured. A "Full Report" PDF must include audience demographics, ads overview, and expert analysis. Users also need progress feedback since section-by-section capture takes several seconds.

Output: Enhanced pdf-export.ts with multi-tab rendering support and progress callback. page.tsx with progress state and UI feedback during export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-export-enhancement/16-RESEARCH.md
@.planning/phases/16-export-enhancement/16-01-SUMMARY.md
@src/lib/pdf-export.ts
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-tab rendering and progress callback to pdf-export.ts</name>
  <files>src/lib/pdf-export.ts, src/app/page.tsx</files>
  <action>
**Part A: Enhance pdf-export.ts function signature and DOM preparation**

Update `exportToPDF` to accept an options object as a third parameter:

```typescript
interface PDFExportOptions {
  onProgress?: (step: string, current: number, total: number) => void;
  showAllTabs?: () => Promise<() => void>;  // Returns cleanup function
}
```

Before the section capture loop:
1. Call `options.showAllTabs?.()` if provided. This makes the caller responsible for rendering all tab content into the DOM. Store the returned cleanup function.
2. Wait 500ms after showing all tabs to let React render and any Recharts animations complete.
3. Fire `onProgress('Preparing document...', 0, totalSections)` before starting.

During the section capture loop:
4. Before each section capture, fire `onProgress('Capturing [section-label]...', index + 1, totalSections)` where section-label is derived from the `data-pdf-section` attribute value formatted nicely (e.g., "age-gender-chart" becomes "Age Gender Chart").
5. After headers/footers are added, fire `onProgress('Finalizing PDF...', totalSections, totalSections)`.

After PDF save:
6. Call the cleanup function returned by `showAllTabs` to restore the original tab state.
7. Ensure cleanup runs even if an error occurs (use try/finally).

**Part B: Update page.tsx to render all tabs during export and show progress**

Add state for PDF progress:
```typescript
const [pdfProgress, setPdfProgress] = useState<{ step: string; current: number; total: number } | null>(null);
```

Create a `showAllTabs` function that:
1. Stores the current `resultsTab` value
2. Temporarily removes the conditional rendering of tab content. The simplest approach: add a state variable `isExporting` (boolean). When `isExporting` is true, render ALL three tab content blocks (audience, ads, expert) simultaneously instead of conditionally based on `resultsTab`. This means changing the three `{resultsTab === 'audience' && ...}` / `{resultsTab === 'ads' && ...}` / `{resultsTab === 'expert' && ...}` conditions to `{(resultsTab === 'audience' || isExporting) && ...}` etc.
3. Return an async cleanup function that sets `isExporting` back to false.

The `showAllTabs` function passed to exportToPDF should:
1. Set `isExporting` to true
2. Return a Promise that resolves after a React render tick (use `await new Promise(r => setTimeout(r, 100))`)
3. Return the cleanup function

Update the PDF export button's onClick handler to:
1. Set `pdfProgress` state as the `onProgress` callback
2. Pass `showAllTabs` in the options
3. Clear `pdfProgress` to null after completion (in finally block)
4. Keep existing `isPdfExporting` for the disabled state

Add progress UI: When `pdfProgress` is not null, show a small progress bar or text below the export button or as an overlay on the analysis-results container. Simple implementation:
- A fixed-position toast-like element at bottom-right, or
- Replace the "Exporting..." text in the button with the progress step name
- Show "Capturing Age Gender Chart... (3/7)" style text

The simplest approach: Replace the button text. When `isPdfExporting` is true and `pdfProgress` is not null, show `pdfProgress.step` as button text instead of "Exporting...". This requires no new UI components.
  </action>
  <verify>Run `npm run build` to confirm TypeScript compiles. Verify that `isExporting` state exists in page.tsx. Verify that all three tab conditions include `|| isExporting`. Verify that `onProgress` callback is called in pdf-export.ts. Verify that `showAllTabs` option exists in the interface.</verify>
  <done>PDF export renders all three tabs simultaneously during capture, progress callback updates the export button text with current step, and tab state is properly restored after export completes or fails.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete PDF export enhancement: section-based capture, cover page, headers/footers, multi-tab content, white background, progress feedback</what-built>
  <how-to-verify>
    1. Run the app locally with `npm run dev`
    2. Analyze any Facebook Ad Library URL (or use existing cached result)
    3. Click the Export dropdown and select "Full Report (PDF)"
    4. Observe the button text showing progress steps during export
    5. Open the generated PDF and verify:
       a. Cover page with brand name, stats, date
       b. Content from all three tabs (audience demographics, ads overview, expert analysis)
       c. Charts are complete (not cut in half at page boundaries)
       d. White/light background throughout (print-friendly)
       e. Header on each content page (brand name + date)
       f. Footer on each content page (page numbers)
       g. Details sections (age/gender, country) are fully expanded in PDF
    6. Verify the app returns to normal state after export (correct tab still active, no visual glitches)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the PDF output</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. PDF includes content from audience, ads, and expert tabs
3. Cover page present with brand name and stats
4. Headers and footers on every content page
5. No chart splitting across page boundaries
6. White background throughout the PDF
7. Progress feedback visible during export
8. App state restored correctly after export
</verification>

<success_criteria>
- Exporting produces a comprehensive multi-section PDF report
- All tabs and collapsed sections are captured regardless of UI state
- User sees progress feedback during the multi-second export process
- App returns to normal state after export completes
- PDF is print-friendly with white background
</success_criteria>

<output>
After completion, create `.planning/phases/16-export-enhancement/16-02-SUMMARY.md`
</output>
