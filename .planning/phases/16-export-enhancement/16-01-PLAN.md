---
phase: 16-export-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/page.tsx
  - src/lib/pdf-export.ts
autonomous: true

must_haves:
  truths:
    - "PDF export captures each section as a separate image (not one giant screenshot)"
    - "PDF has a cover page with brand name, key stats, and generation date"
    - "Every PDF page has a header with brand name and date, and a footer with page numbers"
    - "Charts and summary sections never split across page boundaries"
  artifacts:
    - path: "src/lib/pdf-export.ts"
      provides: "Section-based PDF capture with cover page and headers/footers"
      exports: ["exportToPDF"]
    - path: "src/app/page.tsx"
      provides: "data-pdf-section attributes on capturable sections"
      contains: "data-pdf-section"
  key_links:
    - from: "src/lib/pdf-export.ts"
      to: "src/app/page.tsx"
      via: "querySelectorAll('[data-pdf-section]') discovers sections in DOM"
      pattern: "data-pdf-section"
    - from: "src/app/page.tsx"
      to: "src/lib/pdf-export.ts"
      via: "Export button calls exportToPDF"
      pattern: "exportToPDF"
---

<objective>
Rewrite the PDF export from a single-screenshot-split-across-pages approach to a section-by-section capture with professional formatting.

Purpose: The current export captures one giant DOM element and naively splits it across pages, resulting in charts cut in half, no headers/footers, and no cover page. This plan produces a professional report-quality PDF.

Output: Enhanced pdf-export.ts with section-based capture, cover page, headers/footers/page numbers. page.tsx tagged with data-pdf-section attributes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-export-enhancement/16-RESEARCH.md
@src/lib/pdf-export.ts
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data-pdf-section attributes to page.tsx</name>
  <files>src/app/page.tsx</files>
  <action>
Add `data-pdf-section` attributes to the following sections inside `#analysis-results` so the PDF exporter can discover and capture them individually:

1. The AccountSummary wrapper (around line 1044):
   ```
   <div data-pdf-section="account-summary">
     <AccountSummary result={apiResult} />
   </div>
   ```

2. The "Key Insights" / DemographicsSummary glass panel (around line 1127):
   Add `data-pdf-section="key-insights"` to the existing `<div className="glass rounded-xl p-5">` wrapper.

3. The Age & Gender `<details>` element (around line 1139):
   Add `data-pdf-section="age-gender-chart"` to the `<details>` element.

4. The Country `<details>` element (around line 1166):
   Add `data-pdf-section="country-chart"` to the `<details>` element.

5. In the Ads tab, the ad previews section and the media type / time trends sections. Scan for the major `<div>` containers in the `resultsTab === 'ads'` block and add:
   - `data-pdf-section="ad-previews"` on the FeatureGate wrapper for Top Ads by Reach
   - `data-pdf-section="media-breakdown"` on the media type breakdown section
   - `data-pdf-section="time-trends"` on the time trends section (if one exists)
   - `data-pdf-section="ad-table"` on the ads table section

6. In the Expert tab (around line 1552), add `data-pdf-section="expert-analysis"` to the BrandAnalysis wrapper div.

Also add `data-pdf-hide` attribute to elements that should be hidden during PDF capture:
- The Export dropdown button/container itself
- The tab navigation bar
- The chart filter pill (ActiveChartFilter)
- The "Save for Comparison" button

Do NOT change any logic, state, or behavior. Only add data attributes.
  </action>
  <verify>Run `grep -c 'data-pdf-section' src/app/page.tsx` and confirm at least 7 sections tagged. Run `grep -c 'data-pdf-hide' src/app/page.tsx` and confirm at least 3 elements tagged. Run `npm run build` to confirm no build errors.</verify>
  <done>page.tsx has data-pdf-section attributes on all major content sections and data-pdf-hide on interactive-only elements, with no behavior changes.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite pdf-export.ts with section-based capture, cover page, and headers/footers</name>
  <files>src/lib/pdf-export.ts</files>
  <action>
Rewrite `src/lib/pdf-export.ts` to replace the single-element capture with a section-by-section approach. Keep the same function signature `exportToPDF(result, elementId)` for backward compatibility with page.tsx caller, but enhance the internal implementation.

**Cover page (jsPDF text drawing, no html2canvas):**
- Brand name centered at ~200pt from top, 28pt font, dark gray (#333)
- "Facebook Ad Library Analysis Report" subtitle, 14pt, lighter gray
- Key stats: Total Ads count, Ads with Demographics count, Generation date -- centered, 11pt
- "Generated by BrandSpy" at bottom, 9pt, light gray
- After cover page, add a new page before content

**Section-by-section capture:**
- Find the container element by `elementId`
- Query all `[data-pdf-section]` elements within it
- Before capture: temporarily hide all `[data-pdf-hide]` elements (set display:none, restore after)
- Before capture: force all `<details>` elements inside the container to `open = true` (restore after)
- For each section element:
  - Capture with html2canvas-pro at scale 2, `useCORS: true`, `logging: false`, `backgroundColor: '#ffffff'` (white background for print-friendly output)
  - Calculate if the captured image fits on the remaining page space (track currentY position)
  - If it does not fit, call `pdf.addPage()` and reset currentY
  - Add the captured image with `pdf.addImage()` using PNG format
  - Add 8pt vertical gap between sections
- Use A4 dimensions: 595.28 x 841.89 pt, 30pt margins, reserve 25pt for header and 20pt for footer

**Headers and footers (post-generation loop):**
- After all sections are placed, loop `pdf.getNumberOfPages()` starting from page 2 (skip cover page)
- Header: brand name left-aligned, date right-aligned, 8pt gray text, thin line underneath
- Footer: "Page X of Y" centered, "Generated by BrandSpy" left-aligned, 8pt gray text, thin line above
- Page count should include cover page in the numbering (cover = page 1)

**Filename:** Keep existing pattern: `{pageName}_analysis_{date}.pdf`

**Key implementation notes:**
- Keep dynamic imports for jspdf and html2canvas-pro (code splitting)
- Use PNG format for all captured images (not JPEG -- avoids compression artifacts on chart edges)
- Add 300ms delay before capture to let any animations settle: `await new Promise(r => setTimeout(r, 300))`
- If a section element is not found or has zero height, skip it silently
- Cast html2canvas options with `as Parameters<typeof html2canvas>[1]` to satisfy TypeScript (same pattern as current code)
  </action>
  <verify>Run `npm run build` to confirm TypeScript compiles. Verify the file exports `exportToPDF` function. Read the file and confirm: (1) cover page function exists, (2) querySelectorAll('[data-pdf-section]') is used, (3) header/footer loop iterates pages, (4) backgroundColor is '#ffffff'.</verify>
  <done>pdf-export.ts uses section-by-section capture with cover page, headers/footers on every content page, white background, and controlled page breaks that never split a section.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. `grep 'data-pdf-section' src/app/page.tsx` shows 7+ sections tagged
3. `grep 'data-pdf-hide' src/app/page.tsx` shows 3+ elements tagged
4. `grep 'data-pdf-section' src/lib/pdf-export.ts` confirms section discovery
5. `grep 'getNumberOfPages' src/lib/pdf-export.ts` confirms header/footer loop
6. `grep 'ffffff' src/lib/pdf-export.ts` confirms white background
</verification>

<success_criteria>
- PDF export produces a multi-page report with cover page, not a raw screenshot split across pages
- Each chart/section is captured individually and placed without splitting
- Every content page has header (brand + date) and footer (page numbers)
- White background used for print-friendly output
- Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-export-enhancement/16-01-SUMMARY.md`
</output>
