---
phase: 16
plan: 01
subsystem: export
tags: [pdf, jspdf, html2canvas, export, formatting]

dependency-graph:
  requires: [13-03]
  provides: [section-based-pdf-export, cover-page, headers-footers]
  affects: [16-02]

tech-stack:
  added: []
  patterns: [section-based-capture, data-attribute-discovery, dom-state-save-restore]

file-tracking:
  key-files:
    created: []
    modified:
      - src/lib/pdf-export.ts
      - src/app/page.tsx

decisions:
  - id: "16-01-01"
    decision: "Section discovery via data-pdf-section attributes"
    rationale: "Decouples PDF exporter from page structure; sections self-declare"
  - id: "16-01-02"
    decision: "White background (#ffffff) for print-friendly output"
    rationale: "Dark theme screenshots are unreadable when printed"
  - id: "16-01-03"
    decision: "13 sections tagged (beyond minimum 7)"
    rationale: "Tagged all content sections in all tabs for comprehensive export"

metrics:
  duration: ~3min
  completed: 2026-02-01
---

# Phase 16 Plan 01: Section-Based PDF Export Summary

Section-by-section PDF capture with cover page, headers/footers, and white background replacing the old single-screenshot-split approach.

## What Was Done

### Task 1: Add data-pdf-section attributes to page.tsx
- Tagged 13 content sections with `data-pdf-section` across all three tabs (audience, ads, expert)
- Tagged 5 interactive elements with `data-pdf-hide` (export dropdown, save-for-comparison button, tab navigation, both chart filter pills)
- Sections: account-summary, key-insights, age-gender-chart, country-chart, ad-previews, time-trends, media-breakdown, ad-copy-analysis, ad-longevity, landing-pages, product-analysis, ad-table, expert-analysis
- No logic or behavior changes

### Task 2: Rewrite pdf-export.ts
- Cover page with brand name (28pt), subtitle (14pt), key stats (total ads, demographics count, date), and "Generated by BrandSpy" footer
- Section-by-section capture: discovers `[data-pdf-section]` elements, captures each individually with html2canvas at 2x scale
- Page break logic: sections never split across pages; oversized sections get graceful chunked splitting
- Pre-capture: hides `[data-pdf-hide]` elements, forces all `<details>` open, waits 300ms for animations
- Post-capture: DOM state restored in `finally` block (display values, details open state)
- Headers on pages 2+: brand name left, date right, thin separator line
- Footers on pages 2+: "Generated by BrandSpy" left, "Page X of Y" centered
- White background (#ffffff) for print-friendly output
- Same function signature maintained for backward compatibility

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| 1 | 12685dd | feat(16-01): add data-pdf-section and data-pdf-hide attributes |
| 2 | 7e2822a | feat(16-01): rewrite PDF export with section-based capture |

## Decisions Made

1. **Section discovery via data attributes** -- The PDF exporter queries `[data-pdf-section]` rather than hardcoding selectors. This means page.tsx owns the section boundaries and the exporter stays generic.

2. **White background for print** -- Changed from `#1c1c0d` (dark theme) to `#ffffff`. Dark backgrounds waste ink and look poor when printed.

3. **13 sections tagged** -- Went beyond the minimum 7 to cover all tabs comprehensively (ad copy analysis, ad longevity, landing pages, product analysis were added beyond the plan spec).

4. **Oversized section handling** -- Added chunked splitting for sections taller than one page (e.g., the full ad table), which the plan implied but did not explicitly specify.

## Deviations from Plan

### Auto-added Enhancements

**1. [Rule 2 - Missing Critical] Additional section tags beyond plan spec**
- **Found during:** Task 1
- **Issue:** Plan listed ~7 sections but the ads tab has additional content sections (ad copy analysis, ad longevity, landing pages, product analysis) that would be missing from the PDF
- **Fix:** Tagged all content sections (13 total) for comprehensive export
- **Files modified:** src/app/page.tsx

**2. [Rule 2 - Missing Critical] Oversized section splitting**
- **Found during:** Task 2
- **Issue:** The ad table can be very tall; without splitting, it would overflow a single page
- **Fix:** Added chunked splitting logic for sections taller than the content area
- **Files modified:** src/lib/pdf-export.ts

## Verification Results

| Check | Result |
|-------|--------|
| `npm run build` | Pass (no errors) |
| data-pdf-section count in page.tsx | 13 (>= 7 required) |
| data-pdf-hide count in page.tsx | 5 (>= 3 required) |
| data-pdf-section in pdf-export.ts | Present (section discovery) |
| getNumberOfPages in pdf-export.ts | Present (header/footer loop) |
| #ffffff in pdf-export.ts | Present (white background) |

## Next Phase Readiness

Plan 16-02 (if it exists) can build on this foundation. The section-based capture architecture is extensible -- new sections just need a `data-pdf-section` attribute to be included in the PDF automatically.
