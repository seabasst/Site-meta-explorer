# Milestone v3.1: Competitive Intelligence

**Status:** ✅ SHIPPED 2026-02-03
**Phases:** 28-31
**Total Plans:** 8

## Overview

v3.1 Competitive Intelligence adds four capabilities to the existing brand tracking system: ad creative hook extraction and exploration, side-by-side brand comparison with mirrored demographic charts, and rule-based pattern observations. The approach is data-first (hooks extraction engine), then UI (hook exploration), then independent feature (comparison), then cross-cutting insights (observations that benefit from all prior data).

## Phases

### Phase 28: Hook Extraction Engine

**Goal**: Extract opening hooks from ad creative text, group similar hooks, compute reach-weighted metrics, and persist for saved brands
**Depends on**: Nothing (first phase of v3.1)
**Requirements**: HOOK-01, HOOK-02, HOOK-03, HOOK-07
**Plans**: 2 plans

Plans:
- [x] 28-01: Hook extractor module + HookGroup Prisma model
- [x] 28-02: Wire extraction into save-brand and re-analysis flows

**Details:**
- Created `hook-extractor.ts` with pure functions: extractHook, normalizeHook, groupHooks, extractHooksFromAds
- Added HookGroup Prisma model with snapshotId FK, cascade delete, compound index
- Processes ALL ad_creative_bodies elements (not just [0]) with within-ad deduplication
- rawAdBodies parallel data path on FacebookApiResult for downstream hook extraction
- Atomic transactions for snapshot + hookGroups creation in both save and re-analysis flows

### Phase 29: Hook Exploration UI

**Goal**: Users can browse, search, and drill into extracted hooks on the brand detail page
**Depends on**: Phase 28
**Requirements**: HOOK-04, HOOK-05, HOOK-06
**Plans**: 2 plans

Plans:
- [x] 29-01: GET /api/dashboard/hooks endpoint
- [x] 29-02: HookExplorer and HookCard components + brand detail page integration

**Details:**
- GET /api/dashboard/hooks?snapshotId=XXX with auth, ownership check, BigInt serialization
- HookCard: expandable card with hook text, frequency, reach, Facebook Ad Library links
- HookExplorer: glass container with search input, useMemo client-side filtering, loading skeleton, empty states
- Integrated below country distribution on brand detail page

### Phase 30: Brand Comparison

**Goal**: Side-by-side demographic comparison of two saved brands with mirrored charts
**Depends on**: Nothing (independent of hooks; requires saved brands from v3.0)
**Requirements**: COMP-01, COMP-02, COMP-03, COMP-04, COMP-05
**Plans**: 2 plans

Plans:
- [x] 30-01: ButterflyChart, CountryComparison, and MetricsTable components
- [x] 30-02: Comparison page, BrandSelector, empty state, and dashboard link

**Details:**
- ButterflyChart: Recharts BarChart with negative Brand A / positive Brand B values for age-gender
- CountryComparison: paired horizontal bars with top 8 + Other grouping from merged country sets
- MetricsTable: 8 key stats side-by-side (active ads, reach, spend, demographics, video %, ad age)
- BrandSelector: dual dropdowns with mutual exclusion and swap button
- ComparisonEmpty: two empty states (zero brands, one brand)
- URL param state management with useSearchParams for bookmark/refresh persistence
- Compare Brands link on dashboard page conditionally shown when 2+ brands have snapshots

### Phase 31: Pattern Observations

**Goal**: Auto-generate factual observations from demographic data, surfacing notable patterns without AI/LLM
**Depends on**: Phase 28 (uses hook data for OBSV-04)
**Requirements**: OBSV-01, OBSV-02, OBSV-03, OBSV-04, OBSV-05, OBSV-06
**Plans**: 2 plans

Plans:
- [x] 31-01: Observation engine + card components
- [x] 31-02: Brand detail page integration + visual verification

**Details:**
- Pure function observation engine with 4 threshold-based detectors
- detectDemographicSkew: triggers at dominantAgePct >= 25%
- detectGenderImbalance: triggers at dominantGenderPct > 60%
- detectGeoConcentration: triggers when top 2 countries exceed 50% of reach
- detectHookPattern: triggers at top hook frequency >= 3 and total ads >= 5
- Magnitude normalization per-type for cross-type ranking, capped at 5 observations
- ObservationList returns null when empty (OBSV-06)
- Integrated between brand header and metrics grid on brand detail page

---

## Milestone Summary

**Key Decisions:**

- rawAdBodies as parallel data path (does not modify existing ads conversion)
- Client-side hook extraction for save, server-side for re-analysis
- BigInt for HookGroup.totalReach to match BrandSnapshot convention
- Recharts negative-value technique for butterfly chart
- URL params for comparison brand selection state
- Pure function observation engine with threshold detectors (no AI/LLM)
- Magnitude-based cross-type ranking for fair observation ordering

**Issues Resolved:**

- Recharts v3.6.0 Tooltip formatter type signatures (auto-fixed in Phase 30)
- DATABASE_URL not configured locally (schema validated, migration deferred to deployment)

**Issues Deferred:**

- Database migrations not applied locally (deployment concern, not code gap)

**Technical Debt Incurred:**

None — zero TODOs, FIXMEs, stubs, or placeholder patterns across all four phases.

---

_For current project status, see .planning/ROADMAP.md_
